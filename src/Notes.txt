public class EfaFrame extends JFrame implements AutoCompletePopupWindowCallback {
  public EfaFrameFocusManager focusManager = null;
  String altesZiel = "";        // zum Vergleichen, ob Ziel geändert wurde

  int oldFahrtDauerSelectedIndex=0; // letzte Position von fahrtDauer
  boolean ignoreFahrtDauerItemStateChanges = false; // zum Unterdrücken der StateChanges beim bearbeiten der Liste nach Hinzufügen einer Fahrt
  String fahrtArt_neueMehrtagesfahrt = null;
  String fahrtArt_mehrtagesfahrtBearbeiten = null;
  String fahrtArt_mehrtagesfahrtKonfigurieren = null;

  boolean continueMTour;        // legt fest, ob nächster neuer Eintrag mit unverändertem MTour-Feld (d.h. gleiches Element ausgewählt) begonnen werden soll
  String refDate="";            // Referenzdatum
  boolean askForOpenNewFb=false;// fragen, ob ein neues FB angelegt werden soll (nur beim ersten Start)
  int datumErrorCount=0;        // zum Zählen der Fehler, die beim Setzen des Datums aufgetreten sind
  Mannschaften mannschaften = null; // Liste von Standardmannschaften, die Ruderer oder Steuerleute enthalten
  String mannsch1_label_defaultText = null; // der Standardtext, den das Label "Mannschaft 1: " normalerweise haben soll (wenn es nicht für Einer auf "Name: " gesetzt wird)

  String direkt_boot;           // Bootsname, mit dem EfaFrame aufgerufen wurde
  EfaDirektFrame efaDirektFrame;
  AdminFrame efaDirektAdminFrame;
  Admin admin = null;
  NachrichtenAnAdmin nachrichtenAnAdmin;
  int positionX,positionY;      // Position des Frames, wenn aus efaDirekt aufgerufen
  private boolean _inObmannUpdate = false;


  /**Construct the frame from Efa */
  public EfaFrame(String fb) {
    this.mode = MODE_FULL;
    enableEvents(AWTEvent.WINDOW_EVENT_MASK);
    try {
      this.startOpenFb = fb;
      iniFrameData();
      jbInit();
      infoLabel.setVisible(false);
      bootsschadenButton.setVisible(false);
      packFrame("EfaFrame(...) from Efa");
    }
    catch(Exception e) {
      e.printStackTrace();
    }
    Dialog.frameOpened(this);
  }


  /**Construct the frame from direkt.EfaDirektFrame */
  public EfaFrame(EfaDirektFrame efaDirektFrame, NachrichtenAnAdmin nachrichtenAnAdmin) {
    this.efaDirektFrame = efaDirektFrame;
    this.nachrichtenAnAdmin = nachrichtenAnAdmin;
    this.mode = MODE_START;
    enableEvents(AWTEvent.WINDOW_EVENT_MASK);
    try {
      iniFrameData();
      jbInit();
      infoLabel.setVisible(Daten.efaConfig.efaDirekt_showEingabeInfos.getValue());
      bootsschadenButton.setVisible(Daten.efaConfig.efaDirekt_showBootsschadenButton.getValue());
    }
    catch(Exception e) {
      e.printStackTrace();
    }
    this.setJMenuBar(null);
    contentPane.remove(toolBar);
    fahrtDauerAddItems(true); // add *all* items to fahrtDauer (including MEHRTAGESFAHRT)
    this.efaButton.setVisible(false);

    // bei entspr. Einstellung Obmann-Auswahlliste ausblenden
    if (!Daten.efaConfig.showObmann.getValue()) {
      this.obmannLabel.setVisible(false);
      this.obmann.setVisible(false);
    }

    this.setResizable(false);
    packFrame("EfaFrame(...) from EfaDirektFrame");
  }

  /**Construct the frame from direkt.AdminFrame */
  public EfaFrame(AdminFrame frame, EfaDirektFrame efaDirektFrame, String fb, Admin admin, int mode) {
    this.efaDirektAdminFrame = frame;
    this.efaDirektFrame = efaDirektFrame;
    this.admin = admin;
    this.mode = mode;
    enableEvents(AWTEvent.WINDOW_EVENT_MASK);
    try {
      this.startOpenFb = fb;
      iniFrameData();
      jbInit();
      infoLabel.setVisible(false);
      bootsschadenButton.setVisible(false);
      packFrame("EfaFrame(...) from AdminFrame");
    }
    catch(Exception e) {
      e.printStackTrace();
    }
    if (mode == MODE_ADMIN_NUR_FAHRTEN) {
      this.setJMenuBar(null);
    }
    Dialog.frameOpened(this);
  }

  private void iniFrameData() {
      if (Daten.efaTypes != null && Daten.efaTypes.isConfigured(EfaTypes.CATEGORY_SESSION, EfaTypes.TYPE_SESSION_MULTIDAY)) {
          fahrtArt_neueMehrtagesfahrt = ">>> " + International.getString("neue Mehrtagesfahrt");
          if (mode == MODE_ADMIN_NUR_FAHRTEN) {
              fahrtArt_mehrtagesfahrtBearbeiten = ">>> " + International.getString("Mehrtagesfahrten bearbeiten");
          }
          fahrtArt_mehrtagesfahrtKonfigurieren = ">>> " + International.getString("Mehrtagesfahrt konfigurieren");
      }
  }

  // ActionHandler Events
  public void keyAction(ActionEvent evt) {
    if (evt == null || evt.getActionCommand() == null) return;
    if (evt.getActionCommand().equals("KEYSTROKE_ACTION_0")) { // Escape
      if (isDirectMode() || mode == MODE_ADMIN || mode == MODE_ADMIN_NUR_FAHRTEN) cancel();
    }
    if (evt.getActionCommand().equals("KEYSTROKE_ACTION_1")) { // F1
      switch(mode) {
        case MODE_START:           Help.showHelp("EfaFrame_Start"); break;
        case MODE_START_KORREKTUR: Help.showHelp("EfaFrame_Start"); break;
        case MODE_ENDE:            Help.showHelp("EfaFrame_Ende"); break;
        case MODE_NACHTRAG:        Help.showHelp("EfaFrame_Nachtrag"); break;
        default:                   Help.showHelp(getClass().getCanonicalName());
      }
    }

    if (!isDirectMode() && evt.getActionCommand().equals("KEYSTROKE_ACTION_3")) { // F3
      if (Daten.fahrtenbuch == null) return;
      if (!sicherheitsabfrageDatensatz()) return;
      if (Daten.fahrtenbuch.countElements() == 0) return;
      if ( (Daten.suchMode == Daten.SUCH_NORMAL && Daten.such != null && Daten.such.length() != 0) ||
           (Daten.suchMode == Daten.SUCH_ERROR) )
        SuchFrame.search(this,this);
    }
    if (evt.getActionCommand().equals("KEYSTROKE_ACTION_4")) { // F4
      if (aktDatensatz == null && Daten.mannschaften != null && boot.getText().trim().length()!=0 &&
          Daten.mannschaften.getExact(boot.getText().trim())!= null)
        setStandardMannschaft((DatenFelder)Daten.mannschaften.getComplete());
    }
    // F10 ist nur Dummy, damit beim Vervollständigen im Bemerkungs-Feld nicht das Menü aufklappt
    if (!isDirectMode() && evt.getActionCommand().equals("KEYSTROKE_ACTION_6")) { // Alt-F10
      EfaUtil.gc();
    }
    if (evt.getActionCommand().equals("KEYSTROKE_ACTION_7")) { // F11
      Dialog.infoDialog(
          "Das ist ein sehr langer Satz, der am liebsten über den gesamten Bildschirm gehen würde und nirgends aufhören würde, wenn er nur die Gelegenheit dazu bekäme, denn das würde er wirklich gerne machen, nur leider läßt ihn efa nicht!\n"+
          "DasisteinsehrlangerSatz,deramliebstenüberdengesamtenBildschirmgehenwürdeundnirgendsaufhörenwürde,wennernurdieGelegenheitdazubekäme,denndaswürdeerwirklichgernemachen,nurleiderläßtihnefanicht!\n\n"+
          "Wenn hinter Rollen Rollen rollen, rollen Rollen Rollen nach. Wenn hinter Griechen Griechen kriechen, kriechen Griechen Griechen nach.\n\n"+
          "How much wood would a woodchuck chuck if a woodchuck could chuck wood? If a woodchuck could chuck wood, the wood that a woodchuck would chuck is the wood that a woodchuck could chuck if it could chuck wood.\n\n"+
          "A farmer has set out to market with ten donkeys, on one of which he rode. After a while, he began to wonder if any of the donkeys had strayed and he began counting -- there seemed to be only nine. Disturbed, he dismounted and walked around the herd, counting carefully -- and there were ten after all. So he remounted and went on riding, until worry beset him again. So he counted another time ... and there were nine. So, once again, he dismounted and walked about couting carefully to find ten. The process is repeated until he finally solves the problem, carrying one donkey on his back and driving the other nine before him.\n\n"+
          "2, 3, 5, 7, 11, 13, 17, 19, 23, 29, 31, 37, 41, 43, 47, 53, 59, 61, 67, 71, 73, 79, 83, 89, 97, 101, 103, 107, 109, 113, 127, 131, 137, 139, 149, 151, 157, 163, 167, 173, 179, 181, 191, 193, 197, 199, 211, 223, 227, 229, 233, 239, 241, 251, 257, 263, 269, 271, 277, 281, 283, 293, 307, 311, 313, 317, 331, 337, 347, 349, 353, 359, 367, 373, 379, 383, 389, 397, 401, 409, 419, 421, 431, 433, 439, 443, 449, 457, 461, 463, 467, 479, 487, 491, 499, 503, 509, 521, 523, 541, 547, 557, 563, 569, 571, 577, 587, 593, 599, 601, 607, 613, 617, 619, 631, 641, 643, 647, 653, 659, 661, 673, 677, 683, 691, 701, 709, 719, 727, 733, 739, 743, 751, 757, 761, 769, 773, 787, 797, 809, 811, 821, 823, 827, 829, 839, 853, 857, 859, 863, 877, 881, 883, 887, 907, 911, 919, 929, 937, 941, 947, 953, 967, 971, 977, 983, 991, 997\n\n"+

          "Ein Mann rudert mit konstanter Geschwindigkeit den Mississippi hinauf. Unter einer Brücke rollt ihm eine halbvolle Flasche unbemerkt aus dem Boot. Nach 10 min. bemerkt er den Verlust, kehrt um und erreicht die Flasche 1 km hinter der Brücke. Wie schnell fließt der Mississippi?\n\n"+
          "I saw a man upon the stair,\nA little man who wasn't there.\nHe wasn't there again today;\nGee, I wish he'd go away.\n\n"+
          "Drei Jungen kommen in einen Laden, um einen Fußball für 30 Mark zu kaufen. Jeder gibt dem Lehrling an der Kasse 10 Mark. Doch der Chef hatte am Vormittag den Fußball um 5 Mark auf 25 Mark heruntergesetzt. Also drückt er dem Lehrling 5 Mark in die Hand und schickt ihn los, um den Jungen das zuviel bezahlte Geld zu bringen. Der Lehrling will etwas Kohle selber einsacken und gibt jedem der drei Jungen eine Mark wieder, behält also 2 Mark. Jeder der drei Jungen hat damit 9 Mark bezahlt, macht in Summe 27 Mark. Der Lehrling hat 2 Mark behalten, macht 29 Mark. Wo ist die dreißigste Mark geblieben?");
    }
  }


  /**Component initialization*/
  private void jbInit() throws Exception  {
    ActionHandler ah= new ActionHandler(this);
    try {
      ah.addKeyActions(getRootPane(), JComponent.WHEN_IN_FOCUSED_WINDOW,
                       new String[] {"ESCAPE","F1","F2","F3","F4","F10","shift F10","F11"},
                       new String[] {"keyAction","keyAction","keyAction","keyAction","keyAction","keyAction","keyAction","keyAction"});
    } catch(NoSuchMethodException e) {
      System.err.println("Error setting up ActionHandler");
    }





    focusManager = new EfaFrameFocusManager(this,FocusManager.getCurrentManager());
    FocusManager.setCurrentManager(focusManager);
//focusManager = new EfaFrameFocusManager(this,FocusManager.getCurrentKeyboardFocusManager());
//FocusManager.setCurrentKeyboardFocusManager(focusManager);

    if (!isDirectMode()) appIni();
    appCommonIni();
  }


  /**Overridden so we can exit when window is closed*/
  protected void processWindowEvent(WindowEvent e) {
    super.processWindowEvent(e);
    // folgendes wird bereits in this_windowClosing() erledigt
//    if (e.getID() == WindowEvent.WINDOW_CLOSING) {
//      jMenuFileExit_actionPerformed(null);
//    }
  }



  // prüft, ob der Name ges bereits in einem anderem Steuermanns- oder Mannschaftsfeld eingetragen ist
  private static boolean eingetragenInAnderemFeld(String ges, javax.swing.text.JTextComponent feld, EfaFrame efaFrame) {
    if (ges.equals(efaFrame.stm.getText().trim()) && feld != efaFrame.stm) return true;
    for (int i=0; i<Fahrtenbuch.ANZ_MANNSCH; i++)
      if (ges.equals(efaFrame.mannsch[i].getText().trim()) && feld != efaFrame.mannsch[i]) return true;
    return false;
  }

  void ziel_keyReleased(KeyEvent e) {
    if (Daten.fahrtenbuch != null) {
      vervollstaendige(ziel,zielButton,Daten.fahrtenbuch.getDaten().ziele,e,this,true);
      setZielKm(); // neu in v0.85
    }
  }


// ==================== Menüs und Buttons ======================================

  // Menu: File -> Open Project
  public void menuFile_openProject_actionPerformed(ActionEvent e) {
    if (isDirectMode() || mode == MODE_ADMIN_NUR_FAHRTEN) return;
    if (!sicherheitsabfrage()) return;
//    NewProjectDialog dlg = new NewProjectDialog(this);
//    dlg.createNewProjectAndLogbook();
    startBringToFront(false); // efaDirekt im BRC -- Workaround
  }

  // Menu: File -> Logbooks ...
  public void menuFile_logbooks_actionPerformed(ActionEvent e) {
    if (isDirectMode() || mode == MODE_ADMIN_NUR_FAHRTEN) return;
    if (!sicherheitsabfrage()) return;
//    NewProjectDialog dlg = new NewProjectDialog(this);
//    dlg.createNewProjectAndLogbook();
    startBringToFront(false); // efaDirekt im BRC -- Workaround
  }

  // Menü Datei->Neu
  void jMenuNew_actionPerformed(ActionEvent e) {
    if (isDirectMode() || mode == MODE_ADMIN_NUR_FAHRTEN) return;
    if (!sicherheitsabfrage()) return;

    FahrtenbuchNeuFortsetzenFrame dlg = new FahrtenbuchNeuFortsetzenFrame(this);
    Dialog.setDlgLocation(dlg,this);
    dlg.setModal(!Dialog.tourRunning);
    dlg.show();
    startBringToFront(false); // efaDirekt im BRC -- Workaround
  }



  // Menü Datei->Öffnen
  public void jMenuFileOpen_actionPerformed(ActionEvent e) {
    if (isDirectMode() || mode == MODE_ADMIN_NUR_FAHRTEN) return;
    if (sicherheitsabfrage()) {
      String fb=null;
      if (Daten.fahrtenbuch != null && !Daten.fahrtenbuch.getFileName().equals("")) {
          fb = Dialog.dateiDialog(this,International.getString("Fahrtenbuch öffnen"),
                  International.getString("efa Fahrtenbuch")+" (*.efb)","efb",Daten.fahrtenbuch.getFileName(),false);
      } else {
          fb = Dialog.dateiDialog(this,International.getString("Fahrtenbuch öffnen"),
              International.getString("efa Fahrtenbuch")+" (*.efb)","efb",Daten.efaDataDirectory,false);
      }
      if (fb != null) fahrtenbuchOeffnen(fb);
    }
  }


  // Menü Datei->Fahrtenbuch speichern
  void jMenuFileSave_actionPerformed(ActionEvent e) {
    if (isDirectMode() || mode == MODE_ADMIN_NUR_FAHRTEN) return;
    if (sicherheitsabfrageDatensatz()) speichereFahrtenbuch(false);
  }


  // Menü Datei->Fahrtenbuch speichern unter
  void jMenuFileSaveAs_actionPerformed(ActionEvent e) {
    if (isDirectMode() || mode == MODE_ADMIN_NUR_FAHRTEN) return;
    if (sicherheitsabfrageDatensatz()) speichereFahrtenbuch(true);
  }


  // Menü Datei->Backup einspielen
  void jMenuBackup_actionPerformed(ActionEvent e) {
    if (isDirectMode() || mode == MODE_ADMIN_NUR_FAHRTEN) return;
    RestoreBackupFrame dlg = new RestoreBackupFrame(this);
    Dialog.setDlgLocation(dlg,this);
    dlg.setModal(true);
    dlg.show();
    startBringToFront(false); // efaDirekt im BRC -- Workaround
  }

  // Menü Datei->Datensicherung
  void jMenuFileDatensicherung_actionPerformed(ActionEvent e) {
    DatensicherungFrame dlg;
    try {
      Vector directories = new Vector();
      Vector selected = new Vector();
      Vector inclSubdirs = new Vector();
      directories.add(Daten.efaDataDirectory); selected.add(new Boolean(true)); inclSubdirs.add(new Boolean(true));
      directories.add(Daten.efaCfgDirectory); selected.add(new Boolean(true)); inclSubdirs.add(new Boolean(true));
      directories.add(Daten.efaAusgabeDirectory+"layout"+Daten.fileSep); selected.add(new Boolean(true)); inclSubdirs.add(new Boolean(true));

      // jetzt noch alle Verzeichnisse zusammensuchen, in denen Fahrtenbücher gesichert sind
      int dirCountBefore = directories.size();
      Hashtable visitedFb = new Hashtable();
      Fahrtenbuch fb = Daten.fahrtenbuch;
      while (fb != null) {
        if (visitedFb.get(fb.getFileName()) != null) break;
        visitedFb.put(fb.getFileName(),"foo");
        datensicherungAddDirectories(directories,fb);
        String prev = fb.getPrevFb(true);
        if (prev != null && prev.length()>0 && EfaUtil.canOpenFile(prev)) {
          fb = new Fahrtenbuch(prev); fb.readFile();
        } else {
          fb = null;
        }
      }
      fb = Daten.fahrtenbuch;
      while (fb != null) {
        if (visitedFb.get(fb.getFileName()) != null) break;
        visitedFb.put(fb.getFileName(),"foo");
        datensicherungAddDirectories(directories,fb);
        String next = fb.getNextFb(true);
        if (next != null && next.length()>0 && EfaUtil.canOpenFile(next)) {
          fb = new Fahrtenbuch(next); fb.readFile();
        } else {
          fb = null;
        }
      }
      for (int i=dirCountBefore; i<directories.size(); i++) {
        selected.add(new Boolean(true)); inclSubdirs.add(new Boolean(false));
      }


      dlg = new DatensicherungFrame(this,directories,inclSubdirs,selected);
    } catch(Exception ee) {
      return;
    }
    Dialog.setDlgLocation(dlg,this);
    dlg.setModal(true);
    dlg.show();
    startBringToFront(false); // efaDirekt im BRC -- Workaround
  }
  void datensicherungAddDirectories(Vector dirs, Fahrtenbuch fb) {
    if (fb == null) return;
    if (fb.getFileName() != null && fb.getFileName().length()>0) datensicherungAddDirectory(dirs,fb.getFileName());
    if (fb.getDaten() == null) return;
    if (fb.getDaten().bootDatei != null && fb.getDaten().bootDatei.length()>0) datensicherungAddDirectory(dirs,EfaUtil.makeFullPath(EfaUtil.getPathOfFile(fb.getFileName()),fb.getDaten().bootDatei));
    if (fb.getDaten().mitgliederDatei != null && fb.getDaten().mitgliederDatei.length()>0) datensicherungAddDirectory(dirs,EfaUtil.makeFullPath(EfaUtil.getPathOfFile(fb.getFileName()),fb.getDaten().mitgliederDatei));
    if (fb.getDaten().zieleDatei != null && fb.getDaten().zieleDatei.length()>0) datensicherungAddDirectory(dirs,EfaUtil.makeFullPath(EfaUtil.getPathOfFile(fb.getFileName()),fb.getDaten().zieleDatei));
    if (fb.getDaten().statistikDatei != null && fb.getDaten().statistikDatei.length()>0) datensicherungAddDirectory(dirs,EfaUtil.makeFullPath(EfaUtil.getPathOfFile(fb.getFileName()),fb.getDaten().statistikDatei));
  }
  void datensicherungAddDirectory(Vector dirs, String filename) {
    if (filename == null || filename.indexOf(Daten.fileSep)<0) return;
    String dir = EfaUtil.getPathOfFile(filename);
    if (dir != null && dir.length()>0) {
      if (!dir.endsWith(Daten.fileSep)) dir += Daten.fileSep;
      if (!dirs.contains(dir)) dirs.add(dir);
    }
  }

  // Menü Datei->Fahrtenbuch importieren
  void jMenuImport_actionPerformed(ActionEvent e) {
    if (isDirectMode() || mode == MODE_ADMIN_NUR_FAHRTEN) return;
    if (Daten.fahrtenbuch == null) return;
    if (!sicherheitsabfrageDatensatz()) return;
    ImportFrame dlg = new ImportFrame(this);
    Dialog.setDlgLocation(dlg,this);
    dlg.setModal(!Dialog.tourRunning);
    dlg.show();
    startBringToFront(false); // efaDirekt im BRC -- Workaround
  }

  // Menü Datei->efa Online Update
  void jMenuOnlineUpdate_actionPerformed(ActionEvent e) {
    if (isDirectMode() || mode == MODE_ADMIN_NUR_FAHRTEN) return;
    if (this.mode != MODE_FULL) {
      Dialog.error(International.getString("Diese Funktion steht nur im Basis-Modus von efa zur Verfügung.") + "\n" +
                   International.getString("Bitte starte efa im Basis-Modus, um ein Online-Update durchzuführen."));
      startBringToFront(false); // efaDirekt im BRC -- Workaround
      return;
    }
    if (!sicherheitsabfrage()) return;
    OnlineUpdateFrame.runOnlineUpdate(this,Daten.ONLINEUPDATE_INFO);
  }


  // Menü Datei->Beenden
  void jMenuFileExit_actionPerformed(ActionEvent e) {
    cancel();
  }


  // Menü Konfiguration->Einstellungen zum Fahrtenbuch
  void jMenuItem4_actionPerformed(ActionEvent e) {
    if (isDirectMode() || mode == MODE_ADMIN_NUR_FAHRTEN) return;
    if (Daten.fahrtenbuch == null) return;
    if (!sicherheitsabfrage()) return;
    NeuesFahrtenbuchFrame dlg = new NeuesFahrtenbuchFrame(this,false);
    Dialog.setDlgLocation(dlg,this);
    dlg.setModal(!Dialog.tourRunning);
    dlg.show();
    startBringToFront(false); // efaDirekt im BRC -- Workaround
  }


  // AuswahlFrame (Mitglieder-/Boots-/Zielliste) öffnen
  void oeffneAuswahl(int art) {
    if (isDirectMode() || (mode == MODE_ADMIN_NUR_FAHRTEN && art != AuswahlFrame.MEHRTAGESFAHRTEN)) return;
    AuswahlFrame dlg = new AuswahlFrame(this,art);
    Dialog.setDlgLocation(dlg,this);
    dlg.setModal(!Dialog.tourRunning);
    dlg.show();
    startBringToFront(false); // efaDirekt im BRC -- Workaround
  }


  // Menü Konfiguration->Mitgliederliste
  void jMenuItem5_actionPerformed(ActionEvent e) {
    if (isDirectMode() || mode == MODE_ADMIN_NUR_FAHRTEN) return;
    if (Daten.fahrtenbuch == null || Daten.fahrtenbuch.getDaten().mitglieder == null) return;
    oeffneAuswahl(AuswahlFrame.MITGLIEDER);
  }


  // Menü Konfiguration->Bootsliste
  void jMenuItem6_actionPerformed(ActionEvent e) {
    if (isDirectMode() || mode == MODE_ADMIN_NUR_FAHRTEN) return;
    if (Daten.fahrtenbuch == null || Daten.fahrtenbuch.getDaten().boote == null) return;
    oeffneAuswahl(AuswahlFrame.BOOTE);
  }


  // Menü Konfiguration->Zielliste
  void jMenuItem7_actionPerformed(ActionEvent e) {
    if (isDirectMode() || mode == MODE_ADMIN_NUR_FAHRTEN) return;
    if (Daten.fahrtenbuch == null || Daten.fahrtenbuch.getDaten().ziele == null) return;
    oeffneAuswahl(AuswahlFrame.ZIELE);
  }


  // Menü Konfiguration->Mehrtagesfahrten
  void jMenuItem1_actionPerformed(ActionEvent e) {
    if (isDirectMode()) return;
    if (Daten.fahrtenbuch == null) return;
    if (datensatzGeaendert && !sicherheitsabfrageDatensatz()) return;
    oeffneAuswahl(AuswahlFrame.MEHRTAGESFAHRTEN);
  }

  // Menü Konfiguration->Synonymlisten->Mitglieder
  void openSynFrame(Synonyme synonyme, DatenListe datenliste) {
    if (isDirectMode() || mode == MODE_ADMIN_NUR_FAHRTEN) return;
    SynonymFrame dlg = new SynonymFrame(this,synonyme,datenliste);
    Dialog.setDlgLocation(dlg,this);
    dlg.setModal(!Dialog.tourRunning);
    dlg.show();
    startBringToFront(false); // efaDirekt im BRC -- Workaround
  }
  void jMenuItem8_actionPerformed(ActionEvent e) {
    if (Daten.fahrtenbuch == null) return;
    openSynFrame(Daten.synMitglieder,Daten.fahrtenbuch.getDaten().mitglieder);
  }
  void jMenuItem9_actionPerformed(ActionEvent e) {
    if (Daten.fahrtenbuch == null) return;
    openSynFrame(Daten.synBoote,Daten.fahrtenbuch.getDaten().boote);
  }
  void jMenuItem10_actionPerformed(ActionEvent e) {
    if (Daten.fahrtenbuch == null) return;
    openSynFrame(Daten.synZiele,Daten.fahrtenbuch.getDaten().ziele);
  }

  // Menü Konfiguration->Standardmannschaften
  void jMenuItem12_actionPerformed(ActionEvent e) {
    if (isDirectMode() || mode == MODE_ADMIN_NUR_FAHRTEN) return;
    if (Daten.mannschaften == null) return;
    AuswahlFrame dlg = new AuswahlFrame(this,AuswahlFrame.MANNSCHAFTEN);
    Dialog.setDlgLocation(dlg,this);
    dlg.setModal(!Dialog.tourRunning);
    dlg.show();
    updateMannschaftenAndShowButton();
    startBringToFront(false); // efaDirekt im BRC -- Workaround
  }

  // Menü Konfiguration->Gruppen
  void jMenuItem14_actionPerformed(ActionEvent e) {
    if (isDirectMode() || mode == MODE_ADMIN_NUR_FAHRTEN) return;
    if (Daten.gruppen == null) return;
    AuswahlFrame dlg = new AuswahlFrame(this,AuswahlFrame.GRUPPEN);
    Dialog.setDlgLocation(dlg,this);
    dlg.setModal(!Dialog.tourRunning);
    dlg.show();
    startBringToFront(false); // efaDirekt im BRC -- Workaround
  }

  // Menü Konfiguration->DRV-Fahrtenabzeichen
  void jMenuItem13_actionPerformed(ActionEvent e) {
    if (isDirectMode() || mode == MODE_ADMIN_NUR_FAHRTEN) return;
    if (Daten.fahrtenbuch == null) return;
    AuswahlFrame dlg = new AuswahlFrame(this,AuswahlFrame.FAHRTENABZEICHEN);
    Dialog.setDlgLocation(dlg,this);
    dlg.setModal(!Dialog.tourRunning);
    dlg.show();
    startBringToFront(false); // efaDirekt im BRC -- Workaround
  }



  // Menü Konfiguration->Elektronische Wettbewerbsteilnahme
  void jMenuItem2_actionPerformed(ActionEvent e) {
    if (isDirectMode() || mode == MODE_ADMIN_NUR_FAHRTEN) return;
    VereinsConfigFrame dlg = new VereinsConfigFrame(this,Daten.vereinsConfig);
    Dialog.setDlgLocation(dlg,this);
    dlg.setModal(!Dialog.tourRunning);
    dlg.show();
    startBringToFront(false); // efaDirekt im BRC -- Workaround
  }

  // Menü Konfiguration->Allgemeine Einstellungen
  void jMenuItem3_actionPerformed(ActionEvent e) {
    if (isDirectMode() || mode == MODE_ADMIN_NUR_FAHRTEN) return;
    if ((mode == MODE_ADMIN && (admin == null || !admin.allowedEfaConfig)) ||
        (mode == MODE_FULL && admin != null && !admin.allowedEfaConfig)) {
      Dialog.error(International.getString("Du hast nicht die Berechtigung, diese Funktion auszuführen!"));
      startBringToFront(false); // efaDirekt im BRC -- Workaround
      return;
    }
    EfaConfigFrame dlg = new EfaConfigFrame(this);
    Dialog.setDlgLocation(dlg,this);
    dlg.setModal(!Dialog.tourRunning);
    dlg.show();
    startBringToFront(false); // efaDirekt im BRC -- Workaround
  }

  // Menü Konfiguration->Schreibschutz
  void jMenuItem11_actionPerformed(ActionEvent e) {
    if (isDirectMode() || mode == MODE_ADMIN_NUR_FAHRTEN) return;
    WriteProtectFrame dlg;
    dlg = new WriteProtectFrame(this);
    Dialog.setDlgLocation(dlg,this);
    dlg.setModal(!Dialog.tourRunning);
    dlg.show();
    startBringToFront(false); // efaDirekt im BRC -- Workaround
  }

  // Menü Ausgabe->Statistik erstellen
  void jMenuItemKilometerliste_actionPerformed(ActionEvent e) {
    if (isDirectMode() || mode == MODE_ADMIN_NUR_FAHRTEN) return;
    if (Daten.fahrtenbuch == null) jMenuFileOpen_actionPerformed(null);
    if (Daten.fahrtenbuch == null) return;
    if (!sicherheitsabfrageDatensatz()) return;
    StatistikFrame dlg = new StatistikFrame(this);
    Dialog.setDlgLocation(dlg,this);
    dlg.setModal(!Dialog.tourRunning);
    dlg.show();
    startBringToFront(false); // efaDirekt im BRC -- Workaround
  }


  // Menü Hilfe->Info
  public void jMenuHelpAbout_actionPerformed(ActionEvent e) {
    if (isDirectMode() || mode == MODE_ADMIN_NUR_FAHRTEN) return;
    EfaFrame_AboutBox dlg = new EfaFrame_AboutBox(this);
    Dialog.setDlgLocation(dlg,this);
    dlg.setModal(!Dialog.tourRunning);
    dlg.show();
    startBringToFront(false); // efaDirekt im BRC -- Workaround
  }

  // Menü Hilfe->Java Konsole
  void jMenuHilfeJavaKonsole_actionPerformed(ActionEvent e) {
    if (isDirectMode() || mode == MODE_ADMIN_NUR_FAHRTEN) return;
    KonsoleFrame dlg = new KonsoleFrame(this,Daten.efaLogfile);
    Dialog.setDlgLocation(dlg,this);
    dlg.setModal(!Dialog.tourRunning);
    dlg.show();
    startBringToFront(false); // efaDirekt im BRC -- Workaround
  }

  // Menü Hilfe->Dokumentation
  void jMenuDokumentation_actionPerformed(ActionEvent e) {
    if (isDirectMode() || mode == MODE_ADMIN_NUR_FAHRTEN) return;
    Help.showHelp(null);
  }

  // efa-Tour starten
  void jMenu_supportForum_actionPerformed(ActionEvent e) {
    if (isDirectMode() || mode == MODE_ADMIN_NUR_FAHRTEN) return;
    Dialog.startBrowser(this,Daten.EFASUPPORTURL);
  }

  // Menü Hilfe->efa-Homepage
  void jMenu_efaHomepage_actionPerformed(ActionEvent e) {
    if (isDirectMode() || mode == MODE_ADMIN_NUR_FAHRTEN) return;
    Dialog.startBrowser(this,Daten.EFAURL);
    startBringToFront(false); // efaDirekt im BRC -- Workaround
  }

  // neuen Datensatz beginnen
  void NewButton_actionPerformed(ActionEvent e) {
    if (isDirectMode()) return;
    if (aktDatensatz == null) return; // schon neuer Datensatz angezeigt
    refDatensatz = aktDatensatz;
    if (Daten.fahrtenbuch != null) {
      if (!sicherheitsabfrageDatensatz()) return;
      SetBlankFields();
      if (isAdminMode()) {
        Logger.log(Logger.INFO, Logger.MSG_ADMIN_LOGBOOK_ENTRYADDED,
                International.getString("Admin") + ": " +
                International.getMessage("Neuer Fahrtenbuch-Eintrag #{lfdnr} wurde erstellt.",lfdnr.getText().trim()));
      }
    }
  }


  // neuen Datensatz vor aktuellem einfügen
  void InsertButton_actionPerformed(ActionEvent e) {
    if (isDirectMode()) return;
    if (Daten.fahrtenbuch == null) return;
    if (aktDatensatz == null) { NewButton_actionPerformed(null); return; }
    String curlfd = aktDatensatz.get(Fahrtenbuch.LFDNR);
    if (curlfd != null) curlfd = curlfd.trim();
    if (curlfd == null || curlfd.equals("")) { NewButton_actionPerformed(null); return; }
    if (mode != MODE_FULL) {
      if (efaDirektFrame != null && efaDirektFrame.sindNochBooteUnterwegs()) {
        Dialog.error(International.getString("Es sind noch Boote unterwegs. "+
                     "Das Einfügen von Einträgen ist nur möglich, wenn alle laufenden Fahrten beendet sind."));
        startBringToFront(false);
        return;
      }
    }
    int ret = Dialog.yesNoDialog(International.getString("Eintrag einfügen"),
            International.getMessage("Soll vor dem aktuellen Eintrag (Lfd. Nr. {lfdnr}) wirklich ein neuer Eintrag eingefügt werden?\n"+
        "Alle nachfolgenden laufenden Nummern werden dann um eins erhöht!", curlfd));
    startBringToFront(false); // efaDirekt im BRC -- Workaround
    if (ret != Dialog.YES) return;
    DatenFelder d = null;
    String lfd = null;
    do {
      if (d == null) d = (DatenFelder)Daten.fahrtenbuch.getCompleteLast();
      else d = (DatenFelder)Daten.fahrtenbuch.getCompletePrev();

      // neue Lfd Nr berechnen
      lfd = d.get(Fahrtenbuch.LFDNR).trim();
      int lfd_i = EfaUtil.string2date(lfd,0,0,0).tag;
      String lfd_ch = lfd.substring(Integer.toString(lfd_i).length());
      d.set(Fahrtenbuch.LFDNR,Integer.toString(++lfd_i)+lfd_ch);

      // Eintrag ändern
      Daten.fahrtenbuch.delete(lfd);
      Daten.fahrtenbuch.add(d);
    } while (d != null && !lfd.equals(curlfd));
    NewButton_actionPerformed(null);
    neuerDatensatz_einf = true;
    lfdnr.setText(Integer.toString(EfaUtil.string2date(curlfd,0,0,0).tag));
  }

  // Datensatz Löschen
  void ButtonDelete_actionPerformed(ActionEvent e) {
    if (isDirectMode()) return;
    if (Daten.fahrtenbuch == null || aktDatensatz == null) return;
    if (aktDatensatz.get(Fahrtenbuch.LFDNR).trim().equals("")) return;
    if (Dialog.yesNoDialog(International.getString("Wirklich löschen?"),
            International.getString("Möchtest Du den aktuellen Eintrag wirklich löschen?")) == Dialog.YES) {
      Daten.fahrtenbuch.delete(aktDatensatz.get(Fahrtenbuch.LFDNR));
      if (isAdminMode()) {
        Logger.log(Logger.INFO, Logger.MSG_ADMIN_LOGBOOK_ENTRYDELETED,
                International.getString("Admin")+": "+
                International.getString("Fahrtenbuch-Eintrag")+" #"+(aktDatensatz != null ? aktDatensatz.get(Fahrtenbuch.LFDNR) : "$$")+" wurde gelöscht.");
      }
      DatenFelder d;
      if ((d = (DatenFelder)Daten.fahrtenbuch.getCompleteNext()) != null) SetFields(d);
      else if ((d = (DatenFelder)Daten.fahrtenbuch.getCompleteLast()) != null) SetFields(d);
      else SetBlankFields();
    }
   startBringToFront(false); // efaDirekt im BRC -- Workaround
  }


  // Datensatz suchen
  void SuchButton_actionPerformed(ActionEvent e) {
    if (isDirectMode()) return;
    if (Daten.fahrtenbuch == null) return;
    if (!sicherheitsabfrageDatensatz()) return;
    if (Daten.fahrtenbuch.countElements() == 0) return;
    SuchFrame dlg = new SuchFrame(this);
    Dialog.setDlgLocation(dlg,this);
    dlg.setModal(!Dialog.tourRunning);
    dlg.show();
    startBringToFront(false); // efaDirekt im BRC -- Workaround
  }


  // zwischen Mannschaftsmitgliedern 5-8 und 9-12 umschalten
  void weitereMannschButton_actionPerformed(ActionEvent e) {
    if (Daten.fahrtenbuch == null) return;
    mannschAuswahl++;
    if (mannschAuswahl == 3) mannschAuswahl = 0;
    setActiveMannsch(mannschAuswahl);
    setColoredMannschButton();
    erkenneFelder1bis16();
  }

  void mannschaftSelectButton_actionPerformed(ActionEvent e) {
    if (Daten.fahrtenbuch == null || mannschaften == null || mannschaften.isEmpty()) return;
    MannschaftAuswahlFrame dlg = new MannschaftAuswahlFrame(this,mannschaften);
    Dialog.setDlgLocation(dlg,this);
    dlg.setModal(!Dialog.tourRunning);
    dlg.show();
    startBringToFront(false); // efaDirekt im BRC -- Workaround
  }

  // Check auf Tippfehler bei Booten, Mitgliedern und Zielen
  // basierend auf Code von Thilo Coblenzer
  // The parameters art and liste are German strings; they are passed through International.getString() by this function
  void checkNeighbours(JTextField field, JButton button, DatenListe dl, String art, String liste, boolean mitglied) {
    Vector neighbours = null;
    String name = field.getText().trim();
    if (name.length() == 0) return;

    if (dl.getExact(name) == null) {
      neighbours = dl.getNeighbours(name,3);
      if (neighbours == null && mitglied && Daten.fahrtenbuch != null) {
        String nameUmgedreht = null;
        if (Daten.fahrtenbuch.getDaten().erstVorname && name.indexOf(",")>0) {
          String[] sn = EfaUtil.zerlegeNamen(name,false);
          nameUmgedreht = EfaUtil.getFullName(sn[0],sn[1],sn[2],true);
        }
        if (!Daten.fahrtenbuch.getDaten().erstVorname && name.indexOf(",")<0) {
          String[] sn = EfaUtil.zerlegeNamen(name,true);
          nameUmgedreht = EfaUtil.getFullName(sn[0],sn[1],sn[2],false);
        }
        if (nameUmgedreht != null) neighbours = dl.getNeighbours(nameUmgedreht,3);
      }
    }
    if (neighbours != null) {
      String suggestedName;
      for (Iterator j = neighbours.iterator(); j.hasNext();) {
        DatenFelder d = (DatenFelder)j.next();
        suggestedName = dl.constructKey(d);
        if (Dialog.yesNoDialog(International.getMessage("{art} unbekannt (Tippfehler?)", art),
                               International.getMessage("Der Name '{name}' "+
                               "konnte in der {liste} nicht gefunden werden.",
                               name,liste) + "\n" +
                               International.getMessage("Meintest Du '{suggestedName}'?", suggestedName)) == Dialog.YES) {
          field.setText(suggestedName);
          vervollstaendige(field,button,dl,null,this,false);
          startBringToFront(false); // efaDirekt im BRC -- Workaround
          break;
        }
      }
    }
  }

  Vector getBootsbesatzung(DatenFelder d) {
    if (d == null) return null;
    Vector v = new Vector();
    if (d.get(Fahrtenbuch.STM).length()>0) v.add(d.get(Fahrtenbuch.STM));
    for (int i=0; i<Fahrtenbuch.ANZ_MANNSCH; i++) {
      if (d.get(Fahrtenbuch.MANNSCH1+i).length()>0) v.add(d.get(Fahrtenbuch.MANNSCH1+i));
    }
    return v;
  }

  DatenFelder findDoppeleintrag(DatenFelder d, DatenFelder fb, int range) {
    if (d == null) return null;
    if (fb == null) fb = Daten.fahrtenbuch.getCompleteFirst();

    Vector aktMannsch = getBootsbesatzung(d);
    for (int c=0; c<Math.abs(range); c++) {
      if (fb == null) break;

      if (!d.get(Fahrtenbuch.LFDNR).equals(fb.get(Fahrtenbuch.LFDNR)) &&
          d.get(Fahrtenbuch.BOOT).equals(fb.get(Fahrtenbuch.BOOT)) &&
          d.get(Fahrtenbuch.DATUM).equals(fb.get(Fahrtenbuch.DATUM))) {
        Vector mannsch = getBootsbesatzung(fb);
        int matches = 0;
        for (int i=0; i<aktMannsch.size(); i++) {
          if (mannsch.contains(aktMannsch.get(i))) matches++;
        }
        // Doppeleintrag, wenn
        // - verschiedene LfdNr
        // - gleiches Boot
        // - gleiches Datum
        // - mindestens 1 Mannschaftsmitglied gleich, maximal 2 Mannschaftsmitglieder verschieden
        if (matches > 0 && aktMannsch.size() - matches <=2) return fb;
      }

      if (range < 0) fb = Daten.fahrtenbuch.getCompletePrev();
      else fb = Daten.fahrtenbuch.getCompleteNext();
    }
    return null;
  }


  // aktuellen Datensatz hinzufügen (speichern)
  void addButton_actionPerformed(ActionEvent e) {
    if (Daten.fahrtenbuch == null) return;

    // Da das Hinzufügen eines Eintrags in der Bootshausversion wegen des damit verbundenen
    // Speicherns lange dauern kann, könnte ein ungeduldiger Nutzer mehrfach auf den "Hinzufügen"-
    // Button klicken. "synchronized" hilft hier nicht, da sowieso erst nach Ausführung des
    // Threads der Klick ein zweites Mal registriert wird. Da aber nach Abarbeitung dieser
    // Methode der Frame "EfaFrame" vom Stack genommen wurde und bei der zweiten Methode damit
    // schon nicht mehr auf dem Stack ist, kann eine Überprüfung, ob der aktuelle Frame
    // "EfaFrame" ist, benutzt werden, um eine doppelte Ausführung dieser Methode zu verhindern.
    if (Dialog.frameCurrent() != this) return;

    // Check auf Tippfehler (Code-Spende von Thilo Coblenzer)
    if (Daten.efaConfig != null) {
      if (mode != MODE_ENDE) {
        if (Daten.efaConfig.correctMisspelledBoote.getValue()) {
            checkNeighbours(boot,bootButton,Daten.fahrtenbuch.getDaten().boote,
                International.getString("Boot"),
                International.getString("Bootsliste"),false);
        }
      }
      if (Daten.efaConfig.correctMisspelledMitglieder.getValue()) {
          checkNeighbours(stm,stmButton,Daten.fahrtenbuch.getDaten().mitglieder,
                  International.getString("Mitglied"),
                  International.getString("Mitgliederliste"),true);
      }
      if (Daten.efaConfig.correctMisspelledMitglieder.getValue()) {
          for (int i=0; i<Fahrtenbuch.ANZ_MANNSCH; i++) {
              checkNeighbours(mannsch[i],mannschButton[i % 8],Daten.fahrtenbuch.getDaten().mitglieder,
                      International.getString("Mitglied"),
                      International.getString("Mitgliederliste"),true);
          }
      }
      if (Daten.efaConfig.correctMisspelledZiele.getValue()) {
        checkNeighbours(ziel, zielButton, Daten.fahrtenbuch.getDaten().ziele,
                        International.getString("Ziel"),
                        International.getString("Zielliste"), false);
        if (isDirectMode() && Daten.efaConfig.efaDirekt_eintragNichtAenderbarKmBeiBekanntenZielen.getValue() &&
            ziel.getText().trim().length() > 0) {
          DatenFelder d = Daten.fahrtenbuch.getDaten().ziele.getExactComplete(ziel.getText().trim());
          if (d != null && !bootskm.getText().trim().equals(d.get(Ziele.KM))) {
            bootskm.setText(d.get(Ziele.KM));
          }
        }
      }
    }

    // Ruderer auf doppelte prüfen
    Hashtable h = new Hashtable();
    String s;
    String doppelt = null; // Ergebnis doppelt==null heißt ok, doppelt!=null heißt Fehler! ;-)
    while (true) { // Unsauber; aber die Alternative wäre ein goto; dies ist keine Schleife!!
      if (! (s = stm.getText().trim()).equals("") ) h.put(s,"");
      for (int i=0; i<Fahrtenbuch.ANZ_MANNSCH; i++) {
        if (! (s = mannsch[i].getText().trim()).equals("") ) {
          if (h.get(s) == null) {
            h.put(s,"");
          } else {
            doppelt = s;
            break;
          }
        }
      }
      break; // alles ok, keine doppelten --> Pseudoschleife abbrechen
    }
    if (doppelt != null) {
      Dialog.error(International.getMessage("Die Person '{name}' wurde mehrfach eingegeben!",doppelt));
      startBringToFront(false); // efaDirekt im BRC -- Workaround
      return;
    }

    // bei steuermannslosen Booten keinen Steuermann eingeben
    if (stm.getText().trim().length()>0 && Daten.fahrtenbuch.getDaten().boote != null &&
        Daten.efaTypes != null) {
      DatenFelder b = Daten.fahrtenbuch.getDaten().boote.getExactComplete(boot.getText().trim());
      if (b != null && b.get(Boote.STM).equals(EfaTypes.TYPE_COXING_COXLESS)) {
        int ret = Dialog.yesNoDialog(International.getString("Steuermann"),
                               International.getString("Du hast für ein steuermannsloses Boot einen Steuermann eingetragen. "+
                               "Möchtest Du diesen Eintrag dennoch speichern?"));
        startBringToFront(false); // efaDirekt im BRC -- Workaround
        if (ret != Dialog.YES) return;
      }
    }

    // Prüfen, ob ein Doppeleintrag vorliegt
    if (isDirectMode()) {
      DatenFelder dop = findDoppeleintrag(getFields(null,null,null), Daten.fahrtenbuch.getCompleteLast(), -25); // letzte 25 Einträge nach Doppeleinträgen durchsuchen
      if (dop != null) {
        Vector v = getBootsbesatzung(dop);
        String m = "";
        for (int i=0; i<v.size(); i++) {
          m += (m.length()>0 ? "; " : "") + v.get(i);
        }
        switch(Dialog.auswahlDialog(International.getString("Doppeleintrag?"),
                                    International.getString("efa hat einen ähnlichen Eintrag im Fahrtenbuch gefunden.") + "\n" +
                                    International.getString("Eventuell hast Du oder jemand anderes die Fahrt bereits eingetragen.") + "\n\n" +
                                    International.getString("Vorhandener Eintrag:") + "\n"+
                                    International.getMessage("#{entry} vom {date} mit {boat}",
                                    dop.get(Fahrtenbuch.LFDNR), dop.get(Fahrtenbuch.DATUM), dop.get(Fahrtenbuch.BOOT)) + ":\n"+
                                    International.getString("Mannschaft") + ": " + m + "\n"+
                                    International.getString("Abfahrt") + ": " + dop.get(Fahrtenbuch.ABFAHRT) + "; " +
                                    International.getString("Ankunft") + ": " + dop.get(Fahrtenbuch.ANKUNFT) + "; " +
                                    International.getString("Ziel") + ": " + dop.get(Fahrtenbuch.ZIEL) + " (" + dop.get(Fahrtenbuch.BOOTSKM) + " Km)" + "\n\n" +
                                    International.getString("Bitte füge den aktuellen Eintrag nur hinzu, falls es sich NICHT um einen Doppeleintrag handelt.") + "\n" +
                                    International.getString("Was möchtest Du tun?"),
                                    International.getString("Eintrag hinzufügen") +
                                    " (" + International.getString("kein Doppeleintrag") + ")",
                                    International.getString("Eintrag NICHT hinzufügen") +
                                    " (" + International.getString("Doppeleintrag") + ")",
                                    International.getString("Zurück zum Eintrag"))) {
            case 0: // kein Doppeleintrag: Hinzufügen
                   break;
            case 1: // Doppeleintrag: NICHT hinzufügen
                   cancel();
                   return;
            default: // Zurück zum Eintrag
                   startBringToFront(false); // efaDirekt im BRC -- Workaround
                   return;
        }
      }
    }


    if (isDirectMode()) {
      if (mode == MODE_START || mode == MODE_START_KORREKTUR) {
        // checkFahrtbeginnFuerBoot nur bei direkt_boot==null machen, da ansonsten der Check schon in EfaDirektFrame gemacht wurde
        if (direkt_boot == null && !efaDirektFrame.checkFahrtbeginnFuerBoot(boot.getText().trim(), 2)) {
          return;
        }
      }
      direktSpeichereDatensatz();
      return;
    }

    // Prüfen, ob Eintrag einer Mehrtagesfahrt vorliegt und das Datum in den Zeitraum der Mehrtagesfahrt fällt
    Mehrtagesfahrt mtour = null;
    if (Daten.efaTypes != null &&
        (Daten.efaTypes.getType(EfaTypes.CATEGORY_SESSION, fahrtart.getSelectedIndex()) == null ||
         Daten.efaTypes.getType(EfaTypes.CATEGORY_SESSION, fahrtart.getSelectedIndex()).equals(EfaTypes.TYPE_SESSION_MULTIDAY))) {
        mtour = Daten.fahrtenbuch.getMehrtagesfahrt((String)fahrtart.getSelectedItem());
    }
    if (mtour != null) {
      if (EfaUtil.secondDateIsAfterFirst(datum.getText(),mtour.start) ||
          EfaUtil.secondDateIsAfterFirst(mtour.ende,datum.getText())) {
        Dialog.error(International.getMessage("Das Datum des Fahrtenbucheintrags ({entry}) liegt außerhalb des Zeitraums " +
                " ({date_from} - {date_to}), der für die ausgewählte Mehrtagesfahrt '{name}' angegeben wurde.",
                "#"+lfdnr.getText().trim()+" "+datum.getText().trim(), mtour.start, mtour.ende, mtour.name) +
                "\n\n" +
                International.getString("Falls in diesem Jahr mehrere Mehrtagesfahrten mit derselben Strecke durchgeführt wurden, " +
                "so erstelle bitte für jede einzelne Mehrtagesfahrt einen separaten Eintrag in efa. Ansonsten wähle bitte entweder " +
                "eine Mehrtagesfahrt mit passendem Datum aus oder korrigiere das Datum dieses Eintrages oder der Mehrtagesfahrt."));
        startBringToFront(false); // efaDirekt im BRC -- Workaround
        return;
      }
    }

    // Prüfen, ob neues Jahr vorliegt
    Calendar cal = GregorianCalendar.getInstance();
    TMJ tmj = EfaUtil.string2date(datum.getText().trim(),0,0,0);
    TMJ ref = EfaUtil.correctDate(refDate,cal.get(GregorianCalendar.DAY_OF_MONTH),cal.get(GregorianCalendar.MONTH)+1-cal.getMinimum(GregorianCalendar.MONTH),cal.get(GregorianCalendar.YEAR));
    if (tmj.jahr != ref.jahr && !Daten.fahrtenbuch.isEmpty()) {
      Dialog.infoDialog(International.getString("Warnung"),
		        International.getString("Ein Fahrtenbuch sollte immer nur die Fahrten EINES Jahres enthalten! "+
                                                "Bitte lösche die eben hinzugefügte Fahrt und beginne für die Fahrten "+
                                                "des neuen Jahren ein neues Fahrtenbuch!") + "\n"+
                        International.getMessage("Um ein neues Fahrtenbuch zu beginnen, wähle aus dem Menü '{menu}' den Punkt "+
                                                 "'{create_new_logbook}' und dort die Option '{continue_logbook}'.",
                                                 International.getString("Datei"),
                                                 International.getString("Neues Fahrtenbuch erstellen"),
                                                 International.getString("Fahrtenbuch fortsetzen")
                        ));
      startBringToFront(false); // efaDirekt im BRC -- Workaround
    }

    if (speichereDatensatz() && neuerDatensatz) {
      refDatensatz = aktDatensatz;
      SetBlankFields();
    }
  }

  
  // Standard-Steuermann und Mannschaft für ein Boot setzen
  void setStandardMannschaft(DatenFelder d) {
    boolean _stm = true;
    int _anzRud = Fahrtenbuch.ANZ_MANNSCH;
    if (aktBoot != null && Daten.efaTypes != null) {
      _stm = aktBoot.get(Boote.STM).equals(EfaTypes.TYPE_COXING_COXED);
      _anzRud = EfaTypes.getNumberOfRowers(aktBoot.get(Boote.ANZAHL));
    }

    if (_stm && d.get(Mannschaften.STM).length()>0) stm.setText(d.get(Mannschaften.STM));
    for (int i=0; i<Fahrtenbuch.ANZ_MANNSCH; i++) {
      if (i+1<=_anzRud && d.get(Mannschaften.MANNSCH1+i).length()>0) mannsch[i].setText(d.get(Mannschaften.MANNSCH1+i));
    }
    if (d.get(Mannschaften.ZIEL).length()>0) ziel.setText(d.get(Mannschaften.ZIEL));
    try {
        if (Daten.efaTypes != null && Daten.efaTypes.isConfigured(EfaTypes.CATEGORY_SESSION, d.get(Mannschaften.FAHRTART))) {
            fahrtart.setSelectedItem(Daten.efaTypes.getValue(EfaTypes.CATEGORY_SESSION, (String)d.get(Mannschaften.FAHRTART)));
        }
    } catch(Exception e) { }

    vervollstaendigeAlleFelder();
    setZielKm();

    // Obmann
    int obm = -1;
    try {
      if (!Mannschaften.NO_OBMANN.equals(d.get(Mannschaften.OBMANN))) {
        int nr = EfaUtil.string2date(d.get(Mannschaften.OBMANN),0,0,0).tag; // 0: Steuermann, >0: Mannschaft
        if (nr == 0 && stm.getText().trim().length()>0) obm = 0;
        if (nr > 0 && nr < getAnzahlRuderer() && mannsch[nr-1].getText().trim().length()>0) obm = nr;
        if (obm >= 0) setObmann(obm,true);
      }
    } catch(Exception e) { }

    if (obm == -1 && Daten.efaConfig.autoObmann.getValue()) {
      if (stm.getText().trim().length()>0) setObmann(0,true);
      else if (Daten.efaConfig.defaultObmann.getValue().equals(EfaConfig.OBMANN_BOW)) setObmann(1,true);
           else if (Daten.efaConfig.defaultObmann.getValue().equals(EfaConfig.OBMANN_STROKE)) try {
             int anzRud = getAnzahlRuderer();
             if (anzRud > 0) setObmann(anzRud,true);
           } catch(Exception ee) { EfaUtil.foo(); }
    }

    stm.select(0,stm.getText().length());
    for (int i=0; i<Fahrtenbuch.ANZ_MANNSCH; i++) mannsch[i].select(0,mannsch[i].getText().length());
    ziel.select(0,ziel.getText().length());
    datensatzGeaendert = true;
  }


  // nächstes Eingabefeld ermitteln
  void boot_focusLost(FocusEvent e) {
    boot_focusLostGetBoot();
  }
  void bootButton_focusLost(FocusEvent e) {
    if (Daten.fahrtenbuch != null && Daten.fahrtenbuch.getDaten().boote != null && bootButton.getBackground() != Color.red &&
        Daten.fahrtenbuch.getDaten().boote.getFirst(boot.getText().trim()) != null) {
      aktBoot = (DatenFelder)Daten.fahrtenbuch.getDaten().boote.getComplete();
    }
  }


  void ziel_focusLost(FocusEvent e) {
    if (Daten.efaConfig.popupComplete.getValue()) AutoCompletePopupWindow.hideWindow();
    if (isDirectMode() && ziel.getText().trim().length()>0 && bootskm.getText().trim().length()==0) { altesZiel = ""; setZielKm(); }
  }

  void zielButton_focusLost(FocusEvent e) {
    setZielKm();
  }


  // Kilometer für Ziel ermitteln
  void setZielKm() {
    setFieldEnabledBootsKm();
    if (zielButton.getBackground() == Color.red) {
      if (!ziel.getText().trim().equals(altesZiel)) {
        // Das "Leeren" des Kilometerfeldes darf nur im DirectMode erfolgen. Im normalen Modus hätte das
        // den unschönen Nebeneffekt, daß beim korrigieren von unbekannten Zielen die eingegeben Kilometer
        // aus dem Feld verschwinden (ebenso nach der Suche nach unvollständigen Einträgen mit unbekannten
        // Zielen).
        if (isDirectMode() && (mode == MODE_START || mode == MODE_START_KORREKTUR || mode == MODE_ENDE || mode == MODE_NACHTRAG)) {
          bootskm.setText("");
        }
        altesZiel="";
      }
      return;
    }

    if (!ziel.getText().trim().equals(altesZiel) && !ziel.getText().trim().equals("") &&
        Daten.fahrtenbuch != null &&
        Daten.fahrtenbuch.getDaten().ziele != null) {
      // die folgende Zeile ist korrekt, da diese Methode nur nach "vervollstaendige" und bei
      // "zielButton.getBackground()!=Color.red" aus "ziel_keyReleased" oder "zielButton_focusLost"
      // aufgerufen wird und somit ein gültiger Datensatz bereits gefunden wurde!
      DatenFelder d = (DatenFelder)Daten.fahrtenbuch.getDaten().ziele.getComplete();
      if (d != null && ziel.getText().trim().equals(d.get(Ziele.NAME))) bootskm.setText(d.get(Ziele.KM));
      else {
        d = Daten.fahrtenbuch.getDaten().ziele.getExactComplete(ziel.getText().trim());
        if (d != null) bootskm.setText(d.get(Ziele.KM));
        else bootskm.setText("");    }
      }
    if (!bootskm.isEnabled()) bootskm_focusLost(null);
  }


  // altes Ziel speichern, um bei ziel_focusLost festzustellen, ob verändert
  void ziel_focusGained(FocusEvent e) {
    altesZiel = ziel.getText().trim();
  }


  // Eintrag geändert
  void eintragGeaendert(KeyEvent e) {
    if (e == null || (e.getKeyCode() != KeyEvent.VK_TAB && e.getKeyChar() != '\t')) {
      datensatzGeaendert = true;
    }
  }

  void setFahrtDauerDefault() {
    if (Daten.efaConfig.standardFahrtart.getValue().length() > 0 &&
        Daten.efaTypes != null && Daten.efaTypes.isConfigured(EfaTypes.CATEGORY_SESSION, Daten.efaConfig.standardFahrtart.getValue())) {
            fahrtart.setSelectedItem(Daten.efaTypes.getValue(EfaTypes.CATEGORY_SESSION, Daten.efaConfig.standardFahrtart.getValue()));
    } else {
        if (Daten.efaTypes != null && Daten.efaTypes.isConfigured(EfaTypes.CATEGORY_SESSION, EfaTypes.TYPE_SESSION_NORMAL)) {
            fahrtart.setSelectedItem(Daten.efaTypes.getValue(EfaTypes.CATEGORY_SESSION, EfaTypes.TYPE_SESSION_NORMAL));
        } else {
            fahrtart.setSelectedIndex(0);
        }
    }
  }

  boolean isFahrtDauerMehrtagesfahrtAction(String fahrtart) {
      if (fahrtart == null) return false;
      if (fahrtart.equals(fahrtArt_mehrtagesfahrtBearbeiten) ||
          fahrtart.equals(fahrtArt_mehrtagesfahrtKonfigurieren) ||
          fahrtart.equals(fahrtArt_neueMehrtagesfahrt)) return true;
      return false;
  }


  // anderes Element der Liste fahrtDauer ausgewählt
  void fahrtDauer_itemStateChanged(ItemEvent e) {
    if (ignoreFahrtDauerItemStateChanges) return;
    if (oldFahrtDauerSelectedIndex<0) { oldFahrtDauerSelectedIndex = 9999; return; }
    if (Daten.fahrtenbuch == null) { oldFahrtDauerSelectedIndex = 9999; return; }
    if (fahrtart.getSelectedIndex() == oldFahrtDauerSelectedIndex) { oldFahrtDauerSelectedIndex = 9999; return; } // doppelte Aufrufe verhindern
    if (fahrtart.getSelectedItem() == null) { return; }

    if (!isFahrtDauerMehrtagesfahrtAction((String)fahrtart.getSelectedItem())) {
        datensatzGeaendert = true;
    }
    oldFahrtDauerSelectedIndex = fahrtart.getSelectedIndex();

    if (isDirectMode()) return;

    if (fahrtArt_neueMehrtagesfahrt != null &&
        ((String)fahrtart.getSelectedItem()).equals(fahrtArt_neueMehrtagesfahrt)) {
      String mtourEnddatum = null;
      String mtourRudertage = null;
      if (aktDatensatz != null &&
          aktDatensatz.get(Fahrtenbuch.FAHRTART).startsWith(Fahrtenbuch.CONFIGURE_MTOUR+"@@")) {
        String tmp = aktDatensatz.get(Fahrtenbuch.FAHRTART);
        int pos = tmp.indexOf("@@");
        if (pos>0) {
          tmp = tmp.substring(pos+2,tmp.length());
          pos = tmp.indexOf("@@");
          if (pos>=0) {
            mtourEnddatum = tmp.substring(0,pos);
            mtourRudertage = tmp.substring(pos+2,tmp.length());
          }
        }
      }
      MehrtagestourFrame dlg = new MehrtagestourFrame(this,datum.getText().trim(),mtourEnddatum,mtourRudertage);
      Dialog.setDlgLocation(dlg,this);
      dlg.setModal(!Dialog.tourRunning);
      dlg.show();
      startBringToFront(false); // efaDirekt im BRC -- Workaround
    }
    if (fahrtArt_mehrtagesfahrtBearbeiten != null &&
        ((String)fahrtart.getSelectedItem()).equals(fahrtArt_mehrtagesfahrtBearbeiten)) {
      if (isDirectMode()) return;
      if (Daten.fahrtenbuch == null) return;
      if (datensatzGeaendert && !sicherheitsabfrageDatensatz()) return;
      ignoreFahrtDauerItemStateChanges=true;
      fahrtart.setPopupVisible(false);
      oeffneAuswahl(AuswahlFrame.MEHRTAGESFAHRTEN);
      if (aktDatensatz != null) try {
        String fa = aktDatensatz.get(Fahrtenbuch.FAHRTART);
        getAllFahrtDauer();
        if (fa.length()>0 && fa.startsWith(EfaTypes.TYPE_SESSION_MULTIDAY+":")) {
            fa = fa.substring(EfaTypes.TYPE_SESSION_MULTIDAY.length()+1);
            fahrtart.setSelectedItem(fa);
            fahrtart.setSelectedItem(fa);
        } else {
            setFahrtDauerDefault();
        }
      } catch(Exception ee) {}
      ignoreFahrtDauerItemStateChanges=false;
    }
  }


// ================================== Öffnen, Speichern, Beenden etc. ===========================

  // Programm initialisieren
  void appIni() {
    Calendar cal = GregorianCalendar.getInstance();

    datensatzGeaendert = false;
    aktBoot = null;
    continueMTour = false;

    // Prüfen, ob efa gestartet werden darf
    if (!Daten.efaSec.secFileExists() && admin == null) {
      admin = null;
      do {
        admin = AdminLoginFrame.login(null,International.getString("Zugang nur für Administratoren"));
        if (admin == null) {
            Daten.haltProgram(Daten.HALT_ADMIN);
        }
        if (!admin.allowedFahrtenbuchBearbeiten && !admin.allowedVollzugriff) {
            Dialog.error(International.getMessage("Du hast als Admin {name} keine Berechtigung, das Fahrtenbuch zu bearbeiten!", admin.name));
        }
      } while (!admin.allowedFahrtenbuchBearbeiten && !admin.allowedVollzugriff);
    }

    Daten.iniAllDataFiles();

/*
 * @todo: how to best implement this in efa2??
    if (!startEfaTour && !Daten.efaConfig.version.equals(Daten.PROGRAMMID) && Daten.efaConfig.version.compareTo(Daten.PROGRAMMID) != 0) {
      Dialog.neuBrowserDlg(this,Daten.EFA_SHORTNAME,
              "file:"+Daten.efaProgramDirectory+"html"+Daten.fileSep+"tour"+Daten.fileSep+"k06-001.html", // @todo: How to internationalize the tour?
              750,600,(int)Dialog.screenSize.getWidth()/2-375,(int)Dialog.screenSize.getHeight()/2-300);
 */

    Daten.checkEfaVersion(true);
    Daten.checkJavaVersion(true);
    Daten.checkRegister();

    if (startOpenFb != null && EfaUtil.canOpenFile(startOpenFb)) {
        fahrtenbuchOeffnen(startOpenFb);
    } else if (Daten.efaConfig.letzteDatei.getValue().length() != 0 && EfaUtil.canOpenFile(Daten.efaConfig.letzteDatei.getValue())) {
        fahrtenbuchOeffnen(Daten.efaConfig.letzteDatei.getValue());
    } else if (Daten.efaConfig.letzteDatei.getValue().length() == 0) {
        if (Dialog.yesNoDialog(International.getString("Neues Fahrtenbuch erstellen"),
	    International.getString("Du startest efa heute zum ersten Mal. Möchtest Du ein neues Fahrtenbuch anlegen?")) == Dialog.YES) {
            askForOpenNewFb = true;
        }
    }

/*
 * @todo: how to best implement this in efa2??
    // ggf. fragen, ob es sich um einen Berliner Verein handelt
    if (Daten.efaConfig.version.compareTo("EFA.141")<0 || openWelcome) {
      Daten.efaConfig.showBerlinOptions =
          Dialog.auswahlDialog(International.onlyFor("Berliner Vereine","de"),
                               International.onlyFor("efa verfügt über Funktionen (bzgl. Zielbereichen), die speziell für Berliner Vereine "+
                               "gedacht sind. Die entsprechenden Optionen sind für Nicht-Berliner Vereine nicht "+
                               "relevant und können, um die Übersichtlichkeit zu erhöhen, verborgen werden.\n"+
                               "Bitte wähle aus:","de"),
                               International.onlyFor("Optionen für Berliner Vereine anzeigen","de"),
                               International.onlyFor("Nur-Berlin-relevante Optionen verbergen","de"),
                               false) != 1;
      Daten.efaConfig.writeFile();
    }
 */

/*
 * @todo: how to best implement this in efa2??
    // ggf. nach Zielbereich, in dem der Verein liegt, fragen (wenn zum ersten Mal eine Version neuer/gleich 1.3.5 gestartet wird)
    if (Daten.efaConfig.showBerlinOptions && Daten.vereinsConfig != null &&
        (Daten.efaConfig.version.compareTo("EFA.135")<0 || openWelcome)) Daten.vereinsConfig.askForZielbereichOnStart();
*/

    // bei entspr. Einstellung Obmann-Auswahlliste ausblenden
    if (!Daten.efaConfig.showObmann.getValue()) {
      this.obmannLabel.setVisible(false);
      this.obmann.setVisible(false);
    }
  }

  // Initialisierung, die sowohl im normalen als auch im Direct-Mode ausgeführt werden soll
  void appCommonIni() {
    updateMannschaftenAndShowButton();
  }

  public void updateMannschaftenAndShowButton() {
      if (!Daten.efaConfig.manualStandardmannsch.getValue()) {
          mannschaftSelectButton.setVisible(false);
          return;
      }
    mannschaften = new Mannschaften(null);
    if (Daten.mannschaften != null) {
      DatenFelder d = Daten.mannschaften.getCompleteFirst();
      while (d != null) {
        boolean stm_or_mannsch = false;
        if (d.get(Mannschaften.STM).trim().length()>0) stm_or_mannsch = true;
        for (int i=0; i<24 && !stm_or_mannsch; i++) if (d.get(Mannschaften.MANNSCH1+i).trim().length()>0) stm_or_mannsch = true;
        if (stm_or_mannsch) mannschaften.add(d);
        d = Daten.mannschaften.getCompleteNext();
      }
    }
    mannschaftSelectButton.setVisible(!mannschaften.isEmpty());
  }



  // Mehrtagestour zum FB und zur Auswahlliste hinzufügen (und als akt. Element auswählen)
  void addMehrtagestour(String name, String start, String ende, int rudertage, String gewaesser, boolean isEtappen) {
    if (Daten.fahrtenbuch == null || Daten.fahrtenbuch.getMehrtagesfahrt(name) != null) return;
    Daten.fahrtenbuch.addMehrtagesfahrt(name,start,ende,rudertage,gewaesser,isEtappen);

    ignoreFahrtDauerItemStateChanges=true;
    oldFahrtDauerSelectedIndex=-1;
    setFahrtDauerDefault();
    if (fahrtArt_mehrtagesfahrtBearbeiten != null) {
        oldFahrtDauerSelectedIndex=-1;
        fahrtart.removeItem(fahrtArt_mehrtagesfahrtBearbeiten); // letztes Element ("Mehrtagesfahrten bearbeiten") entfernen
    }
    if (fahrtArt_neueMehrtagesfahrt != null) {
        oldFahrtDauerSelectedIndex=-1;
        fahrtart.removeItem(fahrtArt_neueMehrtagesfahrt); // letztes Element ("neue Mehrtagesfahrt") entfernen
    }
    oldFahrtDauerSelectedIndex=-1;
    fahrtart.addItem(name);
    if (fahrtArt_neueMehrtagesfahrt != null) {
        oldFahrtDauerSelectedIndex=-1;
        fahrtart.addItem(fahrtArt_neueMehrtagesfahrt);
    }
    if (fahrtArt_mehrtagesfahrtBearbeiten != null) {
         oldFahrtDauerSelectedIndex=-1;
         fahrtart.addItem(fahrtArt_mehrtagesfahrtBearbeiten);
    }
    oldFahrtDauerSelectedIndex=-1;
    fahrtart.setSelectedItem(name);
    ignoreFahrtDauerItemStateChanges=false;
    datensatzGeaendert = true;
  }


  void fahrtDauerAddItems(boolean withMehrtagesfahrt) {
      if (Daten.efaTypes != null) {
          for (int i=0; i<Daten.efaTypes.size(EfaTypes.CATEGORY_SESSION); i++) {
              if (!withMehrtagesfahrt &&
                  Daten.efaTypes.getType(EfaTypes.CATEGORY_SESSION, i).equals(EfaTypes.TYPE_SESSION_MULTIDAY)) {
                  // nothing to do
              } else {
                  fahrtart.addItem(Daten.efaTypes.getValue(EfaTypes.CATEGORY_SESSION, i));
              }
          }
      }
  }


  // Alle Angaben zu Mehrtagesfahrten zusammentragen
  // (nur nach FB öffnen aufrufen, da akt. Eintrag nicht gemerkt wird)
  void getAllFahrtDauer() {
    fahrtart.removeAllItems();
    fahrtDauerAddItems(false);
    if (fahrtArt_mehrtagesfahrtKonfigurieren != null && (mode == MODE_ADMIN || mode == MODE_ADMIN_NUR_FAHRTEN)) {
        fahrtart.addItem(fahrtArt_mehrtagesfahrtKonfigurieren);
    }
    if (Daten.fahrtenbuch != null) {
      String[] mtours = Daten.fahrtenbuch.getAllMehrtagesfahrtNamen();
      for (int i=0; mtours != null && i<mtours.length; i++)
        fahrtart.addItem(Daten.fahrtenbuch.getMehrtagesfahrt(mtours[i]).getDisplayName());
    }
    if (fahrtArt_neueMehrtagesfahrt != null) {
        fahrtart.addItem(fahrtArt_neueMehrtagesfahrt);
    }
    if (fahrtArt_mehrtagesfahrtBearbeiten != null) {
        fahrtart.addItem(fahrtArt_mehrtagesfahrtBearbeiten);
    }
    if (fahrtart.getItemCount()>0) {
        setFahrtDauerDefault();
    }
  }




  private String createFahrtartKey(String fahrtart) {
    if (Daten.efaTypes != null && fahrtart != null &&
        !this.isFahrtDauerMehrtagesfahrtAction(fahrtart)) {
        String key = Daten.efaTypes.getTypeForValue(EfaTypes.CATEGORY_SESSION, fahrtart);
        if (key != null) {
           return key;
        } else {
           return EfaTypes.TYPE_SESSION_MULTIDAY + ":" + Mehrtagesfahrt.getNameFromDisplayName(fahrtart);
        }
    }
    return "";
  }

  private DatenFelder getFields(String mtourEnddatum, String mtourRudertage, String mtourName) {
    String fd = createFahrtartKey((String)(fahrtart.getSelectedIndex() >= 0 ? fahrtart.getSelectedItem() : null));

    if (Daten.efaTypes != null && (mode == MODE_ENDE || mode == MODE_NACHTRAG) &&
        fd.startsWith(EfaTypes.TYPE_SESSION_MULTIDAY)) {
      if (mtourName != null) {
        fd = EfaTypes.TYPE_SESSION_MULTIDAY + ":" + mtourName;
      } else {
        fd = Fahrtenbuch.CONFIGURE_MTOUR +
             (mtourEnddatum != null || mtourRudertage != null ? "@@" + (mtourEnddatum != null ? mtourEnddatum : "") +
                                                              "@@" + (mtourRudertage != null ? mtourRudertage : "") : "");
      }
    }

    return Daten.fahrtenbuch.constructFields(EfaUtil.getLfdNr(lfdnr.getText())+"|"+
                          EfaUtil.removeSepFromString(datum.getText().trim())+"|"+
                          EfaUtil.removeSepFromString(boot.getText().trim())+"|"+
                          EfaUtil.removeSepFromString(stm.getText().trim())+"|"+
                          EfaUtil.removeSepFromString(mannsch[0].getText().trim())+"|"+
                          EfaUtil.removeSepFromString(mannsch[1].getText().trim())+"|"+
                          EfaUtil.removeSepFromString(mannsch[2].getText().trim())+"|"+
                          EfaUtil.removeSepFromString(mannsch[3].getText().trim())+"|"+
                          EfaUtil.removeSepFromString(mannsch[4].getText().trim())+"|"+
                          EfaUtil.removeSepFromString(mannsch[5].getText().trim())+"|"+
                          EfaUtil.removeSepFromString(mannsch[6].getText().trim())+"|"+
                          EfaUtil.removeSepFromString(mannsch[7].getText().trim())+"|"+
                          EfaUtil.removeSepFromString(mannsch[8].getText().trim())+"|"+
                          EfaUtil.removeSepFromString(mannsch[9].getText().trim())+"|"+
                          EfaUtil.removeSepFromString(mannsch[10].getText().trim())+"|"+
                          EfaUtil.removeSepFromString(mannsch[11].getText().trim())+"|"+
                          EfaUtil.removeSepFromString(mannsch[12].getText().trim())+"|"+
                          EfaUtil.removeSepFromString(mannsch[13].getText().trim())+"|"+
                          EfaUtil.removeSepFromString(mannsch[14].getText().trim())+"|"+
                          EfaUtil.removeSepFromString(mannsch[15].getText().trim())+"|"+
                          EfaUtil.removeSepFromString(mannsch[16].getText().trim())+"|"+
                          EfaUtil.removeSepFromString(mannsch[17].getText().trim())+"|"+
                          EfaUtil.removeSepFromString(mannsch[18].getText().trim())+"|"+
                          EfaUtil.removeSepFromString(mannsch[19].getText().trim())+"|"+
                          EfaUtil.removeSepFromString(mannsch[20].getText().trim())+"|"+
                          EfaUtil.removeSepFromString(mannsch[21].getText().trim())+"|"+
                          EfaUtil.removeSepFromString(mannsch[22].getText().trim())+"|"+
                          EfaUtil.removeSepFromString(mannsch[23].getText().trim())+"|"+
                          Integer.toString(getObmann())+"|"+
                          EfaUtil.removeSepFromString(abfahrt.getText().trim())+"|"+
                          EfaUtil.removeSepFromString(ankunft.getText().trim())+"|"+
                          EfaUtil.removeSepFromString(ziel.getText().trim())+"|"+
                          EfaUtil.removeSepFromString(bootskm.getText().trim())+"|"+
                          EfaUtil.removeSepFromString(bemerk.getText().trim())+"|"+
                          fd);
  }


  // Fahrtenbuch speichern
  // liefert "true", wenn erfolgreich gespeichert wurde
  boolean speichereFahrtenbuch(boolean unter) {
    if (Daten.fahrtenbuch == null) return false;

    speichereDatenbanken();

    boolean ok = true;
    boolean alsoSaveZusatzlistenInNewDirectory = false;
    String dat;
    String oldFilename = Daten.fahrtenbuch.getFileName();

    if (unter) {
      if (Daten.fahrtenbuch.getFileName() != null && !Daten.fahrtenbuch.getFileName().equals(""))
        dat = Dialog.dateiDialog(this,International.getString("Fahrtenbuch speichern unter"),
                International.getString("efa Fahrtenbuch")+" (*.efb)","efb",Daten.fahrtenbuch.getFileName(),true);
      else
        dat = Dialog.dateiDialog(this,International.getString("Fahrtenbuch speichern unter"),
                International.getString("efa Fahrtenbuch")+" (*.efb)","efb",null,true);

      if (dat == null) ok = false;

      if (ok) {
        if (!dat.endsWith(".") && !dat.toUpperCase().endsWith(".EFB")) {
          dat = dat+".efb";
          if (EfaUtil.canOpenFile(dat)) {
            switch (Dialog.yesNoCancelDialog(International.getString("Datei existiert bereits"),
					International.getMessage("Soll die Datei '{filename}' überschrieben werden?",dat))) {
              case Dialog.YES: break;
              default: return false;
            }
          }
        }

        if (oldFilename != null && oldFilename.length()>0 &&
            !EfaUtil.getPathOfFile(oldFilename).equals(EfaUtil.getPathOfFile(dat))) {
          // Fahrtenbuch wird in einem neuen Verzeichnis gespeichert --> Auch Zusatzdatenlisten dort speichern
          alsoSaveZusatzlistenInNewDirectory = true;
          // ggf. Pfadangaben für Zusatzdatenlisten entfernen
          FBDaten fbDaten = Daten.fahrtenbuch.getDaten();
          fbDaten.bootDatei = EfaUtil.getFilenameWithoutPath(fbDaten.bootDatei);
          fbDaten.mitgliederDatei = EfaUtil.getFilenameWithoutPath(fbDaten.mitgliederDatei);
          fbDaten.zieleDatei = EfaUtil.getFilenameWithoutPath(fbDaten.zieleDatei);
          fbDaten.statistikDatei = EfaUtil.getFilenameWithoutPath(fbDaten.statistikDatei);
        }

        Daten.fahrtenbuch.setFileName(dat);
      }
    }
    if (Daten.fahrtenbuch.getFileName() != null && !Daten.fahrtenbuch.getFileName().equals("") &&
        (!unter || ok)) {
      boolean success = Daten.fahrtenbuch.writeFile();
      String newDir = EfaUtil.getPathOfFile(Daten.fahrtenbuch.getFileName()); if (!newDir.endsWith(Daten.fileSep)) newDir += Daten.fileSep;
      if (success && alsoSaveZusatzlistenInNewDirectory) {
        FBDaten fbDaten = Daten.fahrtenbuch.getDaten();
        fbDaten.boote.setFileName(newDir+fbDaten.bootDatei); fbDaten.boote.writeFile();
        fbDaten.mitglieder.setFileName(newDir+fbDaten.mitgliederDatei); fbDaten.mitglieder.writeFile();
        fbDaten.ziele.setFileName(newDir+fbDaten.zieleDatei); fbDaten.ziele.writeFile();
        fbDaten.statistik.setFileName(newDir+fbDaten.statistikDatei); fbDaten.statistik.writeFile();
      }
      if (isAdminMode()) {
        if (success) {
          Logger.log(Logger.INFO, Logger.MSG_ADMIN_LOGBOOK_CHANGESSAVED,
              International.getString("Admin") + ": " +
              International.getString("Änderungen am Fahrtenbuch gespeichert."));
        } else {
          Logger.log(Logger.ERROR, Logger.MSG_ADMIN_LOGBOOK_CHANGESNOTSVD,
              International.getString("Admin") + ": " +
              International.getString("Die Änderungen am Fahrtenbuch konnten nicht gespeichert werden."));
        }
      }

      if (unter && success) {
        if (Dialog.yesNoDialog(International.getString("Fahrtenbuch öffnen") + "?",
                               International.getMessage("Soll das soeben gespeicherte Fahrtenbuch '{filename}' jetzt benutzt werden?",Daten.fahrtenbuch.getFileName())) == Dialog.YES) {
          if (mode == MODE_FULL) Daten.efaConfig.letzteDatei.setValue(Daten.fahrtenbuch.getFileName());
          this.setTitle(Daten.EFA_SHORTNAME + " - " + Daten.fahrtenbuch.getFileName());
        } else {
          // ursprüngliches Fahrtenbuch wieder laden
          Daten.fahrtenbuch.setFileName(oldFilename);
          Daten.fahrtenbuch.readFile();
        }
      }
      startBringToFront(false); // efaDirekt im BRC -- Workaround
      return success;
    }
    startBringToFront(false); // efaDirekt im BRC -- Workaround
    return false;
  }


  // Zusatzdatenbanken speichern
  void speichereDatenbanken() {
    if (Daten.fahrtenbuch == null) return;
    if (Daten.fahrtenbuch.getDaten().boote != null && Daten.fahrtenbuch.getDaten().boote.isChanged()) {
      if (!Daten.fahrtenbuch.getDaten().boote.writeFile()) {
        Dialog.infoDialog(  	International.getString("Fehler"),
                International.getMessage("Änderungen an der {listname} konnten nicht gespeichert werden!",
                International.getString("Bootsliste")));
      } else {
        if (isAdminMode()) {
          Logger.log(Logger.INFO, Logger.MSG_ADMIN_LOGBOOK_CHANGESSAVED,
                International.getString("Admin") + ": " +
                International.getMessage("Änderungen an {listname} gespeichert.",
                International.getString("Bootsliste")));
        }
      }
      if (Daten.synBoote != null && Daten.synBoote.isChanged()) { // Auch Synonyme wegen ggf. hinzugefügter Kombiboote speichern!
        if (!Daten.synBoote.writeFile()) {
          Dialog.infoDialog(	International.getString("Fehler"),
                  International.getMessage("Änderungen an der {listname} konnten nicht gespeichert werden!",
                  International.getString("Boots-Synonymliste")));
        }
      }
    }
    if (Daten.fahrtenbuch.getDaten().mitglieder != null && Daten.fahrtenbuch.getDaten().mitglieder.isChanged()) {
      if (!Daten.fahrtenbuch.getDaten().mitglieder.writeFile()) {
        Dialog.infoDialog(		International.getString("Fehler"),
                International.getMessage("Änderungen an der {listname} konnten nicht gespeichert werden!",
                International.getString("Mitgliederliste")));
      } else {
          Logger.log(Logger.INFO, Logger.MSG_ADMIN_LOGBOOK_CHANGESSAVED,
                International.getString("Admin") + ": " +
                International.getMessage("Änderungen an {listname} gespeichert.",
                International.getString("Mitgliederliste")));
      }
    }
    if (Daten.fahrtenbuch.getDaten().ziele != null && Daten.fahrtenbuch.getDaten().ziele.isChanged()) {
      if (!Daten.fahrtenbuch.getDaten().ziele.writeFile()) {
        Dialog.infoDialog(		International.getString("Fehler"),
                International.getMessage("Änderungen an der {listname} konnten nicht gespeichert werden!",
                International.getString("Zielliste")));
      } else {
          Logger.log(Logger.INFO, Logger.MSG_ADMIN_LOGBOOK_CHANGESSAVED,
                International.getString("Admin") + ": " +
                International.getMessage("Änderungen an {listname} gespeichert.",
                International.getString("Zielliste")));
      }
    }
  }

  void updateWoTag() {
    wotag.setText("("+EfaUtil.getWoTag(datum.getText().trim())+")");
  }


  // vervollstaendige() für alle Felder aufrufen
  void vervollstaendigeAlleFelder() {
    vervollstaendige(boot,bootButton,Daten.fahrtenbuch.getDaten().boote,null,this,false);
    vervollstaendige(stm,stmButton,Daten.fahrtenbuch.getDaten().mitglieder,null,this,false);
    erkenneFelder1bis16();
    vervollstaendige(ziel,zielButton,Daten.fahrtenbuch.getDaten().ziele,null,this,false);
    setColoredMannschButton();
  }


  // Datums-Feld im try-Block setzten (Java-Bug-Workaround)
  void datumSetText(String s) {
    // die folgenden Anweisungen im try-Block, weil datum.setText() unter Linux manchmal
    // völlig unerklärlich eine Exception auslöst.
    try {
      datum.setText(s);
    } catch(Exception e) {
      try {
        datum.setText(s);
      } catch(Exception ee) {
          // solche schwachsinnigen Fehlermeldungen wollen wir lieber nicht in andere Sprachen übersetzen! ;-)
/*
        try {
          if (datumErrorCount++ == 0 && !datum.getText().equals(s))
            Dialog.error(International.getXXXString("Ein Java-Fehler beim Setzen des Datums ist aufgetreten!\n"+
                         "Bitte setze den Cursor von Hand ins Datums-Feld (einfach "+
                         "einmal mit der Maus ins Datums-Feld klicken) und setze "+
                         "die Arbeit dann fort."));
        } catch(Exception eeee) {
          Dialog.error(International.getXXXString("Ein Java-Fehler beim Setzen des Datums ist aufgetreten!\n"+
                       "Bitte setze den Cursor von Hand ins Datums-Feld (einfach "+
                       "einmal mit der Maus ins Datums-Feld klicken) und setze "+
                       "die Arbeit dann fort."));
        }
*/
      }
    }
  }


  // Mannschaftsfelder erkennen
  void erkenneFelder1bis16() {
    for (int i=0; i<8; i++)
      vervollstaendige(mannsch[i + mannschAuswahl * 8],mannschButton[i],Daten.fahrtenbuch.getDaten().mitglieder,null,this,false);
  }

  // Felder zurücksetzen
  void SetBlankFields() {
    Mnemonics.setButton(this, addButton, International.getStringWithMnemonic("Eintrag zum Fahrtenbuch hinzufügen"));

    lfdnr.setText("");
    datumSetText(""); updateWoTag();
    boot.setText("");
    stm.setText("");
    for (int i=0; i<Fahrtenbuch.ANZ_MANNSCH; i++) mannsch[i].setText("");
    abfahrt.setText("");
    ankunft.setText("");
    ziel.setText("");
    bootskm.setText("");
    bemerk.setText("");
    setObmann(-1,true);

    mannschAuswahl = 0;
    setActiveMannsch(mannschAuswahl);
    setColoredMannschButton();

    if (fahrtart.getItemCount()>0 && !continueMTour) {
      setFahrtDauerDefault();
    }
    DatenFelder d;
    if (Daten.fahrtenbuch != null) d = (DatenFelder)Daten.fahrtenbuch.getCompleteLast();
    else d = null;
    try {
      if (!isDirectMode() && lfdNrForNewEntry > 0) { // Seit letztem Hinzufügen eines neuen Datensatzes wurde nicht im FB navigiert: Neue LfdNr ist die des zuletzt eingetragenen Datensatzes + 1
        lfdnr.setText(Integer.toString(lfdNrForNewEntry+1));
      } else { // noch kein Eintrag hinzugefügt oder im FB navigiert seit Hinzufügen: Neue LfdNr ist letzte + 1
        if (d != null) {
          lfdnr.setText(Integer.toString(EfaUtil.string2date(d.get(Fahrtenbuch.LFDNR),1,1,1).tag+1));
        }
      }
      if (d != null) {
        refDate = d.get(Fahrtenbuch.DATUM);
      }
      setDateFromRefDate();
      datum.requestFocus();
      datum.select(0,datum.getText().trim().length());
    } catch(Exception ee) {
      lfdnr.requestFocus();
    }
    setGrayButtons();

    aktBoot = null;
    neuerDatensatz = true;
    neuerDatensatz_einf = false;
    aktDatensatz = null;
    datensatzGeaendert = false;
  }


  // alle Buttons (neben den Feldern) auf grau setzen, sowie Ref-Felder auf ""
  void setGrayButtons() {
    setButtonColor(bootButton,Color.lightGray);
    setButtonColor(stmButton,Color.lightGray);
    for (int i=0; i<8; i++) setButtonColor(mannschButton[i],Color.lightGray);
    setButtonColor(zielButton,Color.lightGray);
    setButtonColor(weitereMannschButton,Color.lightGray);
  }


  // Abfrage, ob geänderter Datensatz gespeichert werden soll;
  // liefert "true", wenn weitergemacht werden darf
  boolean sicherheitsabfrageDatensatz() {
    if (Daten.fahrtenbuch == null) return true;
    if (isDirectMode()) return true;
    if (datensatzGeaendert) {
      String txt;
      if (neuerDatensatz) txt= International.getString("Der aktuelle Eintrag wurde verändert und noch nicht zum Fahrtenbuch hinzugefügt. "+
                               "Möchtest Du ihn jetzt hinzufügen?");
      else txt = International.getString("Änderungen an dem aktuellen Eintrag wurden noch nicht gespeichert.") +
                 "\n" + International.getString("Möchtest Du die Änderungen jetzt speichern?");
      switch(Dialog.yesNoCancelDialog(International.getString("Eintrag nicht gespeichert"),txt)) {
        case Dialog.YES: speichereDatensatz(); break;
        case Dialog.NO: break;
        default: startBringToFront(false); // efaDirekt im BRC -- Workaround
                 return false;
      }
    }
    startBringToFront(false); // efaDirekt im BRC -- Workaround
    return true;
  }


  // Sicherheitsabfrage, ob Zusatzdatenbanken schon gespeichert
  // liefert "true", wenn weitergemacht werden darf
  boolean sicherheitsabfrageZusatzdatenbanken() {
    if (Daten.fahrtenbuch == null) return true;
    if (isDirectMode()) return true;
    if ( (Daten.fahrtenbuch.getDaten().mitglieder != null && Daten.fahrtenbuch.getDaten().mitglieder.isChanged()) ||
         (Daten.fahrtenbuch.getDaten().boote != null && Daten.fahrtenbuch.getDaten().boote.isChanged()) ||
         (Daten.fahrtenbuch.getDaten().ziele != null && Daten.fahrtenbuch.getDaten().ziele.isChanged())) {
      int ret =  Dialog.yesNoCancelDialog(International.getString("Änderungen nicht gespeichert"),
						International.getString("Änderungen an den Datenlisten wurden noch nicht gespeichert.") +
                                             "\n" +  International.getString("Möchtest Du die Änderungen jetzt speichern?"));
      startBringToFront(false); // efaDirekt im BRC -- Workaround
      switch (ret) {
        case Dialog.YES: speichereDatenbanken(); return true;
        case Dialog.NO: return true;
        default: return false;
      }
    } else return true;
  }


  // Sicherheitsabfrage, ob Fahrtenbuch schon gespeichert
  // liefert "true", wenn weitergemacht werden darf
  boolean sicherheitsabfrage() {
    if (Daten.fahrtenbuch == null) return true; // kein Fahrtenbuch angelegt -> getippte Zeichen ignorieren
    if (isDirectMode()) return true;

    if (!sicherheitsabfrageDatensatz()) return false;

    if (Daten.fahrtenbuch.isChanged()) {
      int ret = Dialog.yesNoCancelDialog(International.getString("Änderungen nicht gespeichert"),
						International.getString("Änderungen am Fahrtenbuch wurden noch nicht gespeichert.") +
                                                "\n"+
                                                International.getString("Möchtest Du die Änderungen jetzt speichern?"));
      startBringToFront(false); // efaDirekt im BRC -- Workaround
      switch (ret) {
        case Dialog.YES: return speichereFahrtenbuch(false);
        case Dialog.NO: return sicherheitsabfrageZusatzdatenbanken();
        default: return false;
      }
    } else return sicherheitsabfrageZusatzdatenbanken();

  }


  // Eingabedialog zum Erstellen eines Fahrtenbuchs zeigen;
  // wird von FahrtenbuchNeuFortsetzenFrame aufgerufen
  public void neuesFahrtenbuchDialog(boolean neu) {
    if (isDirectMode() || mode == MODE_ADMIN_NUR_FAHRTEN) return;
    NeuesFahrtenbuchFrame dlg = new NeuesFahrtenbuchFrame(this,neu);
    Dialog.setDlgLocation(dlg,this);
    dlg.setModal(!Dialog.tourRunning);
    if (neu && askForOpenNewFb) dlg.fahrtenbuch.setText(GregorianCalendar.getInstance().get(GregorianCalendar.YEAR)+".efb");
    askForOpenNewFb=false;
    dlg.show();
    startBringToFront(false); // efaDirekt im BRC -- Workaround
  }


  // Neues Fahrtenbuch erstellen (wird von NeuesFahrtenbuchFrame aufgerufen)
  public void neuesFahrtenbuch() {
    if (Daten.fahrtenbuch == null) return;
    continueMTour = false;
    refDate="";
    refDatensatz=null;
    SetBlankFields();
    lfdnr.setText("1");
    this.setTitle(Daten.EFA_SHORTNAME + " - " + Daten.fahrtenbuch.getFileName());
    if (mode == MODE_FULL) Daten.efaConfig.letzteDatei.setValue(Daten.fahrtenbuch.getFileName());
    getAllFahrtDauer();
    if (Daten.fahrtenbuch != null && Daten.fahrtenbuch.getDaten().mitglieder != null)
      Daten.fahrtenbuch.getDaten().mitglieder.getAliases();
    datensatzGeaendert = false;
  }

  public void userInteractionsUponStart() {
    if (askForOpenNewFb) {
      neuesFahrtenbuchDialog(true);
    }
  }


  // Programm beenden
  void cancel() {
    if (mode != MODE_FULL) {
      if (mode == MODE_ADMIN || mode == MODE_ADMIN_NUR_FAHRTEN) {
        if (efaDirektAdminFrame == null) return;
        if (!sicherheitsabfrage()) return;
        Dialog.frameClosed(this);
        dispose();
        efaDirektAdminFrame.fahrtenbuchClosed();
        efaDirektAdminFrame=null;
        return;
      }
      hideEfaFrame();
      efaDirektFrame.setEnabled(true);
      efaDirektFrame.toFront();
      return;
    }
    if (!sicherheitsabfrage()) return;
    if (!Daten.efaConfig.writeFile()) {
        LogString.logError_fileWritingFailed(Daten.efaConfig.getFileName(), International.getString("Konfigurationsdatei"));
    }
    Daten.haltProgram(0);
  }

  void efaButton_actionPerformed(ActionEvent e) {
    this.jMenuHelpAbout_actionPerformed(null);
  }


// ================================= METHODEN FUER DEN AUFRUF AUS EFADIREKTFRAME ==============================

  public void setFixedLocation(int x, int y) {
    if (x>=0 && y>=0) {
      this.positionX = x;
      this.positionY = y;
    }
    this.setLocation(this.positionX,this.positionY);
  }

  private void showEfaFrame(Component focusComponent) {
    if (infoLabel.isVisible() != Daten.efaConfig.efaDirekt_showEingabeInfos.getValue()) {
      infoLabel.setVisible(Daten.efaConfig.efaDirekt_showEingabeInfos.getValue());
    }
    packFrame("showEfaFrame()");
    setFixedLocation(-1,-1);
    this.show();
    this.setVisible(true);
    this.toFront();
    Dialog.frameOpened(this);
    if (focusComponent != null) focusComponent.requestFocus();

    startBringToFront(true);
  }

  public void startBringToFront(boolean always) {
    // Irgendwie ist im BRC das EfaFrame immer dann, wenn zuvor eine Dialog-Box aufpoppte, noch immer nicht
    // im Vordergrund; daher dieser Workaround
    if (!always) {
      // nur im Admin-Mode nach vorne bringen
      if (!isAdminMode()) return;
      if (this.isActive()) {
          if (Logger.isTraceOn(Logger.TT_GUI)) {
              Logger.log(Logger.DEBUG,Logger.MSG_DEBUG_GENERIC,
                         "Dialog closed: EfaFrame is already active.");
          }
        return;
      }
      if (Logger.isTraceOn(Logger.TT_GUI)) {
          Logger.log(Logger.DEBUG,Logger.MSG_DEBUG_GENERIC,
                     "Dialog closed: EfaFrame is inactive and will be brought to front.");
      }
    }
    (new EfaFrameBringToFrontThread(this,100)).start();
  }

  private void hideEfaFrame() {
    this.hide();
    Dialog.frameClosed(this);
  }

  public void direktFahrtAnfang(String boot, String person) {
    this.direkt_boot = boot;
    Component focusComponent = null;
    this.mode = MODE_START;
    this.setTitle(International.getString("Neue Fahrt beginnen"));
    SetBlankFields();
    if (this.lfdnr.getText().trim().length()==0) this.lfdnr.setText("1");

    this.refDate=""; datumSetText(""); // damit aktuelles Datum im Datums-Feld erscheint...
    setDateFromRefDate();
    if (boot != null) this.boot.setText(boot);
    vervollstaendige(this.boot,bootButton,Daten.fahrtenbuch.getDaten().boote,null,this,false);
    setTime(abfahrt,Daten.efaConfig.efaDirekt_plusMinutenAbfahrt.getValue(), null);
    Mnemonics.setButton(this, addButton, International.getStringWithMnemonic("Fahrt beginnen"));

    setFieldEnabled(false, true, lfdnr, lfdnrLabel, null);
    setFieldEnabled(true, true, datum, datumLabel, null);
    setFieldEnabled(boot == null, true, this.boot, bootLabel, bootButton);
    setFieldEnabled(true, true, stm, stmLabel, stmButton);
    if (Daten.efaConfig.efaDirekt_eintragNichtAenderbarUhrzeit.getValue()) {
      setFieldEnabled(false, true, abfahrt, abfahrtLabel, null);
      setFieldEnabled(false, false, ankunft, ankunftLabel, null);
    } else {
      setFieldEnabled(true, true, abfahrt,abfahrtLabel, null);
      setFieldEnabled(false, false, ankunft, ankunftLabel, null);
    }
    setFieldEnabled(true, true, ziel, zielLabel, zielButton);
    setFieldEnabled(false, false, bootskm, bootskmLabel, null);
    setFieldEnabled(true, true, bemerk, bemerkLabel, null);
    if (boot != null) {
      DatenFelder d = Daten.fahrtenbuch.getDaten().boote.getExactComplete(boot);
      setFieldEnabledStmUndMannsch(d);
      if (Daten.mannschaften != null && Daten.efaConfig.autoStandardmannsch.getValue() &&
          boot.length()!=0 &&
          Daten.mannschaften.getExact(boot)!= null) {
        setStandardMannschaft((DatenFelder)Daten.mannschaften.getComplete());
      }
      if (stm.isEnabled()) focusComponent = stm;
      else focusComponent = mannsch[0];
    } else {
      setFieldEnabledStmUndMannsch(null);
      focusComponent = this.boot;
    }
    if (person != null) {
        mannsch[0].setText(person);
        vervollstaendige(mannsch[0],mannschButton[0],Daten.fahrtenbuch.getDaten().mitglieder,null,this,false);
        mannsch1_focusLost(null);
    }
    boot_focusLostGetBoot();
    bootskm.setText(""); // falls durch "Standardmannschaft" bereits ein Fahrtziel (und somit auch die Km) eingetragen wurden
    setFieldEnabled(false, false, null, null, bootsschadenButton);
    showEfaFrame(focusComponent);
  }

  public void direktFahrtAnfangKorrektur(String boot, String lfdnr) {
    this.mode = MODE_START_KORREKTUR;
    this.direkt_boot = boot;
    this.setTitle(International.getString("Eintrag korrigieren"));
    DatenFelder d = (DatenFelder)Daten.fahrtenbuch.getExactComplete(lfdnr);
    if (d == null) {
      Logger.log(Logger.ERROR, Logger.MSG_ERR_NOLOGENTRYFORBOAT,
              International.getString("Fahrtbeginn") +
              " (" + International.getString("Korrektur") + "): " +
              International.getMessage("Die gewählte Fahrt #{lfdnr} ({boot}) konnte nicht gefunden werden!", lfdnr, boot));
      Dialog.error(International.getMessage("Die gewählte Fahrt #{lfdnr} ({boot}) konnte nicht gefunden werden!", lfdnr, boot));
      Dialog.frameOpened(this); // Bugfix: Damit es nicht zur Stack-Inkonsistenz kommt!
      cancel();
      return;
    }
    SetFields(d);
    Mnemonics.setButton(this, addButton, International.getStringWithMnemonic("Fahrt beginnen") +
            " (" + International.getString("Korrektur") +")");

    setFieldEnabled(false, true, this.lfdnr, lfdnrLabel, null);
    setFieldEnabled(true, true, datum, datumLabel, null);
    setFieldEnabled(true, true, this.boot, bootLabel, bootButton);
    if (Daten.efaConfig.efaDirekt_eintragNichtAenderbarUhrzeit.getValue()) {
      setFieldEnabled(false, true, abfahrt, abfahrtLabel, null);
      setFieldEnabled(false, false, ankunft, ankunftLabel, null);
    } else {
      setFieldEnabled(true, true, abfahrt, abfahrtLabel, null);
      setFieldEnabled(false, false, ankunft, ankunftLabel, null);
    }
    setFieldEnabled(true, true, ziel, zielLabel, zielButton);
    setFieldEnabled(false, false, bootskm, bootskmLabel, null);
    setFieldEnabled(true, true, bemerk, bemerkLabel, null);

    if (boot != null) {
      DatenFelder db = Daten.fahrtenbuch.getDaten().boote.getExactComplete(boot);
      setFieldEnabledStmUndMannsch(db);
    } else setFieldEnabledStmUndMannsch(null);

    bootskm.setText(""); // falls durch "Standardmannschaft" bereits ein Fahrtziel (und somit auch die Km) eingetragen wurden
    setFieldEnabled(false, false, null, null, bootsschadenButton);
    showEfaFrame(datum);
  }

  public void direktFahrtEnde(String boot, String lfdnr) {
    this.mode = MODE_ENDE;
    this.direkt_boot = boot;
    this.setTitle(International.getString("Fahrt abschließen"));
    DatenFelder d = (DatenFelder)Daten.fahrtenbuch.getExactComplete(lfdnr);
    if (d == null) {
      Logger.log(Logger.ERROR, Logger.MSG_ERR_NOLOGENTRYFORBOAT,
              International.getString("Fahrtende") + ": " +
              International.getMessage("Die gewählte Fahrt #{lfdnr} ({boot}) konnte nicht gefunden werden!", lfdnr, boot));
      Dialog.error(International.getMessage("Die gewählte Fahrt #{lfdnr} ({boot}) konnte nicht gefunden werden!", lfdnr, boot));
      efaDirektFrame.fahrtBeendet(boot,true);
      Dialog.frameOpened(this); // Bugfix: Damit es nicht zur Stack-Inkonsistenz kommt!
      cancel();
      return;
    }
    SetFields(d);
    setTime(ankunft,-Daten.efaConfig.efaDirekt_minusMinutenAnkunft.getValue(), abfahrt.getText().trim());
    if (d.get(Fahrtenbuch.BOOTSKM).equals("0")) bootskm.setText("");
    if (d.get(Fahrtenbuch.ZIEL).length()>0 && bootskm.getText().length() == 0) {
      DatenFelder ziel = Daten.fahrtenbuch.getDaten().ziele.getExactComplete(d.get(Fahrtenbuch.ZIEL));
      if (ziel != null) {
        bootskm.setText(ziel.get(Ziele.KM));
      }
    }

    Mnemonics.setButton(this, addButton, International.getStringWithMnemonic("Fahrt abschließen"));

    setFieldEnabled(false, true, this.lfdnr, lfdnrLabel, null);
    setFieldEnabled(false, true, datum, datumLabel, null);
    setFieldEnabled(false, true, this.boot, bootLabel, bootButton);
    if (Daten.efaConfig.efaDirekt_eintragNichtAenderbarUhrzeit.getValue()) {
      setFieldEnabled(false, true, abfahrt, abfahrtLabel, null);
      setFieldEnabled(false, true, ankunft, ankunftLabel, null);
    } else {
      setFieldEnabled(true, true, abfahrt, abfahrtLabel, null);
      setFieldEnabled(true, true, ankunft, ankunftLabel, null);
    }
    setFieldEnabled(true, true, ziel, zielLabel, zielButton);
    setFieldEnabledBootsKm();
    setFieldEnabled(true, true, bemerk, bemerkLabel, null);

    if (boot != null) {
      DatenFelder db = Daten.fahrtenbuch.getDaten().boote.getExactComplete(boot);
      setFieldEnabledStmUndMannsch(db);
    } else setFieldEnabledStmUndMannsch(null);

    setFieldEnabled(true, Daten.efaConfig.efaDirekt_showBootsschadenButton.getValue(), null, null, bootsschadenButton);

    showEfaFrame(ziel);
  }

  public void direktFahrtNachtrag(String bootPreselected) {
    this.mode = MODE_NACHTRAG;
    this.direkt_boot = bootPreselected;
    this.setTitle(International.getString("Nachtrag"));
    SetBlankFields();
    if (this.lfdnr.getText().trim().length()==0) this.lfdnr.setText("1");

    this.refDate=""; datumSetText(""); // damit aktuelles Datum im Datums-Feld erscheint...
    setDateFromRefDate();
    Mnemonics.setButton(this, addButton, International.getStringWithMnemonic("Nachtrag speichern"));

    setFieldEnabled(false, true, lfdnr, lfdnrLabel, null);
    setFieldEnabled(true, true, datum, datumLabel, null);
    setFieldEnabled(true, true, boot, bootLabel, bootButton);
    setFieldEnabledStmUndMannsch(null);
    setFieldEnabled(true, true, abfahrt, abfahrtLabel, null);
    setFieldEnabled(true, true, ankunft, ankunftLabel, null);
    setFieldEnabled(true, true, ziel, zielLabel, zielButton);
    setFieldEnabled(true, true, bootskm, bootskmLabel, null);
    setFieldEnabled(true, true, bemerk, bemerkLabel, null);
    if (bootPreselected != null) {
      boot.setText(bootPreselected);
      vervollstaendige(boot,bootButton,Daten.fahrtenbuch.getDaten().boote,null,this,false);
      DatenFelder db = Daten.fahrtenbuch.getDaten().boote.getExactComplete(bootPreselected);
      setFieldEnabledStmUndMannsch(db);
    } else {
        setFieldEnabledStmUndMannsch(null);
    }
    setFieldEnabled(true, Daten.efaConfig.efaDirekt_showBootsschadenButton.getValue(), null, null, bootsschadenButton);
    showEfaFrame(datum);
  }

  public String stmMannsch2String() {
    String s;
    String pers = ( (s = stm.getText().trim())       == null || s.length()==0 ? "" : s+"; " );
    for (int i=0; i<Fahrtenbuch.ANZ_MANNSCH; i++) if ( (s = mannsch[i].getText().trim()).length()>0 ) pers += s+"; ";
    if (pers.length()>2) pers = pers.substring(0,pers.length()-2);
    return pers;
  }

  private boolean unbekannterName(JTextField field, DatenListe daten) {
    return (field.getText().trim().length()>0 && daten != null &&
        daten.getExactComplete(field.getText().trim()) == null);
  }

  void direktSpeichereDatensatz() {
    String direktBootOriginalName = ""; // Name des Bootes, welches bei efaDirekt ursprünglich übergeben wurde (um Änderungen des Bootsnamens bei Korrektur der Fahrt festzustellen)
    String mtourName = null; // Bei Mehrtagesfahrten der Name der Mehrtagesfahrt
    if (aktDatensatz != null) direktBootOriginalName = aktDatensatz.get(Fahrtenbuch.BOOT);

    if (boot.getText().trim().length()==0) {
      if (mode == MODE_NACHTRAG) {
        if (Dialog.yesNoDialog(International.getString("Kein Bootsname angegeben"),
                               International.getString("Du hast keinen Bootsnamen angegeben.\nMöchtest Du das Feld wirklich leer lassen?")) != Dialog.YES) {
          boot.requestFocus();
          startBringToFront(false); // efaDirekt im BRC -- Workaround
          return;
        }
      } else {
        Dialog.error(International.getString("Bitte gib einen Bootsnamen ein!"));
        boot.requestFocus();
        return;
      }
    }
    abfahrt_focusLost(null); ankunft_focusLost(null);

    String pers = stmMannsch2String();
    if (pers.length()==0) {
      Dialog.error(International.getString("Bitte trage mindestens eine Person ein!"));
      stm.requestFocus();
      return;
    }

    // falls noch nicht geschehen, ggf. automatisch Obmann auswählen
    if (Daten.efaConfig.autoObmann.getValue() && getObmann() < 0) {
      autoSetObmann();
    }

    // Obmann-Auswahl (Autokorrektur, neu in 1.7.1)
    if (getObmann() == 0 && stm.getText().trim().length() == 0 && mannsch[0].getText().trim().length() > 0) setObmann(1,true);
    if (getObmann() > 0 && mannsch[getObmann()-1].getText().trim().length() == 0 && stm.getText().trim().length() > 0) setObmann(0,true);
    if (getObmann() > 0 && mannsch[getObmann()-1].getText().trim().length() == 0 && mannsch[0].getText().trim().length() > 0) setObmann(1,true);
    // Obmann-Check
    if ( (getObmann() == 0 && stm.getText().trim().length()==0) ||
         (getObmann()  > 0 && mannsch[getObmann()-1].getText().trim().length()==0) ) {
      Dialog.error(International.getString("Bitte wähle als Obmann eine Person aus, die tatsächlich im Boot sitzt!"));
      obmann.requestFocus();
      return;
    }

    if (Daten.efaConfig.efaDirekt_eintragErzwingeObmann.getValue() && getObmann() < 0) {
      Dialog.error(International.getString("Bitte wähle einen Obmann aus!"));
      obmann.requestFocus();
      return;
    }

    // Prüfen, ob ggf. nur bekannte Boote/Ruderer/Ziele eingetragen wurden
    if (Daten.efaConfig.efaDirekt_eintragNurBekannteBoote.getValue() && unbekannterName(boot,Daten.fahrtenbuch.getDaten().boote)) {
      Dialog.error(International.getMessage("Das Boot '{bootsname}' ist unbekannt. Bitte trage ein bekanntes Boot ein!", boot.getText().trim()));
      boot.requestFocus();
      return;
    }
    if (Daten.efaConfig.efaDirekt_eintragNurBekannteRuderer.getValue() && unbekannterName(stm,Daten.fahrtenbuch.getDaten().mitglieder)) {
      Dialog.error(International.getMessage("Person '{name}' ist unbekannt. Bitte trage eine bekannte Person ein!", stm.getText().trim()));
      stm.requestFocus();
      return;
    }
    for (int i=0; i<mannsch.length; i++) {
      if (Daten.efaConfig.efaDirekt_eintragNurBekannteRuderer.getValue() && unbekannterName(mannsch[i],Daten.fahrtenbuch.getDaten().mitglieder)) {
        Dialog.error(International.getMessage("Person '{name}' ist unbekannt. Bitte trage eine bekannte Person ein!", mannsch[i].getText().trim()));
        mannsch[i].requestFocus();
        return;
      }
    }
    if (Daten.efaConfig.efaDirekt_eintragNurBekannteZiele.getValue() && unbekannterName(ziel,Daten.fahrtenbuch.getDaten().ziele)) {
      Dialog.error(International.getMessage("Das Ziel '{ziel}' ist unbekannt. Bitte trage ein bekanntes Ziel ein!", ziel.getText().trim()));
      ziel.requestFocus();
      return;
    }

    // ***Ersetzt durch Konfigurieren der Mehrtagesfahrt direkt durch das Mitglied***
    // ***Folgende beide Variablen werden nicht mehr genutzt und bleiben auf "null" initialisiert***
    String enddatum=null,rudertage=null;

    if (mode == MODE_START || mode == MODE_START_KORREKTUR) {
      if (ziel.getText().trim().length()==0 && Daten.efaConfig.efaDirekt_zielBeiFahrtbeginnPflicht.getValue()) {
        Dialog.error(International.getString("Bitte trage ein voraussichtliches Fahrtziel ein!"));
        ziel.requestFocus();
        return;
      }

      // Auf nicht erlaubte Ruderer prüfen
      DatenFelder b = null;
      if (Daten.fahrtenbuch != null && Daten.fahrtenbuch.getDaten().boote != null) b = Daten.fahrtenbuch.getDaten().boote.getExactComplete(boot.getText().trim());
      if (b != null && b.get(Boote.GRUPPEN).length() > 0 && Daten.gruppen != null) {
        String nichtErlaubt = null;
        int nichtErlaubtAnz = 0;
        Vector g = Boote.getGruppen(b);
        for (int i=0; i<Fahrtenbuch.ANZ_MANNSCH; i++) {
          String m = mannsch[i].getText().trim();
          if (m.length() > 0) {
            boolean inAnyGroup = false;
            for (int j=0; j<g.size(); j++) {
              if (Daten.gruppen.isInGroup((String)g.get(j),EfaUtil.getVorname(m),EfaUtil.getNachname(m),EfaUtil.getVerein(m))) inAnyGroup = true;
            }
            if (!inAnyGroup) {
              nichtErlaubt = (nichtErlaubt == null ? m : nichtErlaubt + "\n" + m);
              nichtErlaubtAnz++;
            }
          }
        }
        if (nichtErlaubtAnz > EfaUtil.string2int(b.get(Boote.MAX_NICHT_IN_GRUPPE),0)) {
          String erlaubteGruppen = null;
          for (int j=0; j<g.size(); j++) {
            erlaubteGruppen = (erlaubteGruppen == null ? (String)g.get(j) : erlaubteGruppen + (j+1<g.size() ? ", "+g.get(j) : " " +
                    International.getString("und") + " " + g.get(j)) ); // @todo: for some languages it might be necessary to translate ", " as well, or even use a ChoiceFormat here
          }
          switch (Dialog.auswahlDialog(International.getString("Boot nur für bestimmte Gruppen freigegeben"),
                                 International.getMessage("Dieses Boot dürfen nur {list_of_valid_groups} nutzen.",erlaubteGruppen) + "\n" +
                                 International.getMessage("{nichtErlaubtAnz,choice,1#Folgende Person gehört diesen Gruppen nicht an und darf das Boot daher nicht nutzen:|2#Folgende Personen gehören diesen Gruppen nicht an und dürfen das Boot daher nicht nutzen:}",
                                 nichtErlaubtAnz) + " \n" + nichtErlaubt + "\n" +
                                 International.getString("Was möchtest Du tun?"),
                                 International.getString("Anderes Boot wählen"),
                                 International.getString("Mannschaft ändern"),
                                 International.getString("Trotzdem benutzen"),
                                 International.getString("Eintrag abbrechen"))) {
            case 0:
              this.setFieldEnabled(true, true, this.boot, this.bootLabel, bootButton);
              this.boot.setText("");
              this.boot.requestFocus();
              return;
            case 1:
              this.mannsch[0].requestFocus();
              return;
            case 2:
              Logger.log(Logger.INFO, Logger.MSG_EVT_UNALLOWEDBOATUSAGE,
                      International.getString("Unerlaubte Benutzung eines Bootes") + ": " +
                      International.getString("LfdNr") + "=" + lfdnr.getText().trim() + " " +
                      International.getString("Boot") + "=" + boot.getText().trim() + " " +
                      International.getString("Mannschaft") + "=" + pers);
              break;
            case 3:
              cancel();
              return;
          }
        }
      }

      // Prüfen, ob mind 1 Ruderer (oder Stm) der Gruppe "mind 1 aus Gruppe" im Boot sitzt
      if (b != null && b.get(Boote.MIND_1_IN_GRUPPE).length() > 0 && Daten.gruppen != null) {
        String gruppe = b.get(Boote.MIND_1_IN_GRUPPE);
        int gefunden = 0;

        String m = stm.getText().trim();
        if (m.length()>0 && Daten.gruppen.isInGroup(gruppe,EfaUtil.getVorname(m),EfaUtil.getNachname(m),EfaUtil.getVerein(m))) gefunden++;
        for (int i=0; i<Fahrtenbuch.ANZ_MANNSCH; i++) {
          m = mannsch[i].getText().trim();
          if (m.length()>0 && Daten.gruppen.isInGroup(gruppe,EfaUtil.getVorname(m),EfaUtil.getNachname(m),EfaUtil.getVerein(m))) gefunden++;
        }

        if (gefunden == 0) {
          switch (Dialog.auswahlDialog(International.getString("Boot erfordert bestimmte Berechtigung"),
                                 International.getMessage("In diesem Boot muß mindestens ein Mitglied der Gruppe {groupname} sitzen.",gruppe) + "\n" +
                                 International.getString("Was möchtest Du tun?"),
                                 International.getString("Anderes Boot wählen"),
                                 International.getString("Mannschaft ändern"),
                                 International.getString("Trotzdem benutzen"),
                                 International.getString("Eintrag abbrechen"))){
            case 0:
              this.setFieldEnabled(true, true, this.boot, this.bootLabel, bootButton);
              this.boot.setText("");
              this.boot.requestFocus();
              return;
            case 1:
              this.mannsch[0].requestFocus();
              return;
            case 2:
              Logger.log(Logger.INFO, Logger.MSG_EVT_UNALLOWEDBOATUSAGE,
                      International.getString("Unerlaubte Benutzung eines Bootes") + ": " +
                                "#" + lfdnr.getText().trim() + " - " + boot.getText().trim() + " " +
                                International.getMessage("mit {crew}",pers));
              break;
            case 3:
              cancel();
              return;
          }
        }
      }


      if (mode == MODE_START) {
          Logger.log(Logger.INFO, Logger.MSG_EVT_TRIPSTART,
                  International.getString("Fahrtbeginn") + ": " +
                                "#" + lfdnr.getText().trim() + " - " + boot.getText().trim() + " " +
                                International.getMessage("mit {crew}",pers));
      } else {
          Logger.log(Logger.INFO, Logger.MSG_EVT_TRIPSTART_CORR,
                  International.getString("Fahrtbeginn korrigiert") + ": " +
                                "#" + lfdnr.getText().trim() + " - " + boot.getText().trim() + " " +
                                International.getMessage("mit {crew}",pers));
      }
      this.bootskm.setText(""); this.ankunft.setText(""); // wenn alle diese Werte "" sind, gilt der Eintrag als noch nicht zurückgetragen
      speichereDatensatzInFB(true,null,null,null);
      if (!Daten.fahrtenbuch.writeFileOnlyLastRecordChanged()) {
          LogString.logError_fileWritingFailed(Daten.fahrtenbuch.getFileName(), International.getString("Fahrtenbuch"));
      }
      if (mode == MODE_START) {
        efaDirektFrame.fahrtBegonnen(
                boot.getText().trim(),
                lfdnr.getText().trim(),
                datum.getText().trim(),
                abfahrt.getText().trim(),
                pers,
                createFahrtartKey((String)fahrtart.getSelectedItem()),
                ziel.getText().trim());
      } else {
        // Fahrtbeginn korrigiert
        if (direktBootOriginalName.equals(boot.getText().trim())) {
          // Bootsname nicht geändert
          efaDirektFrame.fahrtBeginnKorrigiert(
                  direkt_boot,
                  lfdnr.getText().trim(),
                  datum.getText().trim(),
                  abfahrt.getText().trim(),
                  pers,
                  createFahrtartKey((String)fahrtart.getSelectedItem()),
                  ziel.getText().trim(),
                  direkt_boot);
        } else {
          // Bootsname wurde geändert
          efaDirektFrame.fahrtBeginnKorrigiert(
                  boot.getText().trim(),
                  lfdnr.getText().trim(),
                  datum.getText().trim(),
                  abfahrt.getText().trim(),
                  pers,
                  createFahrtartKey((String)fahrtart.getSelectedItem()),
                  ziel.getText().trim(),
                  direkt_boot);
        }
      }
    } else { // MODE_ENDE oder MODE_NACHTRAG
      if (ziel.getText().trim().length()==0 && !Daten.efaConfig.skipZiel.getValue()) {
        Dialog.error(International.getString("Bitte trage ein Fahrtziel ein!"));
        ziel.requestFocus();
        return;
      }
      String km = bootskm.getText().trim();
      if (km.length()==0 || EfaUtil.zehntelString2Int(km)==0) {
        Dialog.error(International.getString("Bitte trage die gefahrenen Kilometer ein!"));
        bootskm.requestFocus();
        return;
      }

      // Mehrtagesfahrt?
      if (Daten.efaTypes != null && Daten.efaTypes.isConfigured(EfaTypes.CATEGORY_SESSION, EfaTypes.TYPE_SESSION_MULTIDAY) &&
              EfaTypes.TYPE_SESSION_MULTIDAY.equals(Daten.efaTypes.getTypeForValue(EfaTypes.CATEGORY_SESSION, fahrtart.getSelectedItem().toString()))) {
        mtourName = WanderfahrtSelectFrame.selectWanderfahrt(this,lfdnr.getText().trim(),datum.getText().trim(),boot.getText().trim(),stmMannsch2String(),ziel.getText().trim());
        if (mtourName == null) return;
        Mehrtagesfahrt mf = Daten.fahrtenbuch.getMehrtagesfahrt(mtourName);
        if (mf != null && mf.start != null && mf.start.length()>0) this.datum.setText(mf.start);
      }


      if (mode == MODE_ENDE) {
        Logger.log(Logger.INFO, Logger.MSG_EVT_TRIPEND,
                International.getString("Fahrtende") + ": " +
                                "#" + lfdnr.getText().trim() + " - " + boot.getText().trim() + " " +
                                International.getMessage("mit {crew}",pers) + "; " +
                                International.getString("Abfahrt") + ": " + abfahrt.getText().trim() + ", " +
                                International.getString("Ankunft") + ": " + ankunft.getText().trim() + "; " +
                                International.getString("Ziel") + ": " + ziel.getText().trim() + "; " +
                                International.getString("Km") + ": " + bootskm.getText().trim());
        Daten.fahrtenbuch.delete(this.lfdnr.getText().trim());
        speichereDatensatzInFB(false,enddatum,rudertage,mtourName);
        if (!Daten.fahrtenbuch.writeFile()) {
          LogString.logError_fileWritingFailed(Daten.fahrtenbuch.getFileName(), International.getString("Fahrtenbuch"));
        }
        efaDirektFrame.fahrtBeendet(direkt_boot,true);
      } else if (mode == MODE_NACHTRAG) {
        Logger.log(Logger.INFO, Logger.MSG_EVT_TRIPLATEREC,
                International.getString("Nachtrag") + ": " +
                                "#" + lfdnr.getText().trim() + " - " + boot.getText().trim() + " " +
                                International.getMessage("mit {crew}",pers) + "; " +
                                International.getString("Abfahrt") + ": " + abfahrt.getText().trim() + ", " +
                                International.getString("Ankunft") + ": " + ankunft.getText().trim() + "; " +
                                International.getString("Ziel") + ": " + ziel.getText().trim() + "; " +
                                International.getString("Km") + ": " + bootskm.getText().trim());
        speichereDatensatzInFB(true,enddatum,rudertage,mtourName);
        // wir müssen hier writeFile() verwenden anstatt writeFileOnlyLastRecordChanged(),
        // da bei einem Nachtrag (ebenso wie beim Beenden von Fahrten) u.U. auch die Liste der Mehrtagesfahrten
        // am Anfang der Datei mit verändert wird.
        if (!Daten.fahrtenbuch.writeFile()) {
          LogString.logError_fileWritingFailed(Daten.fahrtenbuch.getFileName(), International.getString("Fahrtenbuch"));
        }
        efaDirektFrame.fahrtNachgetragen();
      } else {
        Logger.log(Logger.ERROR, Logger.MSG_ERR_UNEXPECTED,
                International.getString("Programmfehler") +
                ": Unexpected Mode ["+mode+"] for direktSpeichereDatensatz()!");
      }
    }

    cancel();
  }


  void bootsschadenButton_actionPerformed(ActionEvent e) {
    if (efaDirektFrame == null || isAdminMode()) return;

    String boot = this.boot.getText().trim();
    NachrichtAnAdminFrame dlg = new NachrichtAnAdminFrame(this,Daten.nachrichten,Nachricht.BOOTSWART,
                      (getObmannTextField(getObmann()) != null ? getObmannTextField(getObmann()).getText() : null),
                      International.getString("Bootsschaden"),
                      International.getString("LfdNr")+": "+lfdnr.getText()+"\n"+
                      International.getString("Datum")+": "+datum.getText()+"\n"+
                      International.getString("Boot")+": "+boot+"\n"+
                      International.getString("Mannschaft")+": "+stmMannsch2String()+"\n"+
                      "-----------------------\n"+
                      International.getString("Beschreibung des Schadens")+":\n");
    Dialog.setDlgLocation(dlg,this);
    dlg.setModal(true);
    dlg.show();
    if (dlg.isGesendet()) {
      String s = this.bemerk.getText().trim();
      this.bemerk.setText(s + (s.length()>0 ? "; " : "") + International.getString("Bootsschaden gemeldet") + ".");
      Nachricht n = dlg.getLastMessage();
      if (n != null && n.nachricht != null) {
        String t = "";
        int pos = n.nachricht.indexOf(International.getString("Beschreibung des Schadens")+":");
        if (pos >= 0) {
          t = n.nachricht.substring(pos+(International.getString("Beschreibung des Schadens")+":").length());
        }
        if (t.length() == 0) {
            t = International.getString("Bootsschaden"); // generic
        }
        t = EfaUtil.replace(t,"\n"," ",true).trim();
        efaDirektFrame.setBootstatusSchaden(boot,t);
      }
    }
  }


}
